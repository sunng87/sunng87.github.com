
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Using Yan in Ruby Web Application - 车水马龙</title>
  <meta name="author" content="Sun Ning">

  
  <meta name="description" content="I will show you the usage of Yan captcha service. In this tutorial, it&#8217;s based on a simple ruby web application of the Sinatra web framework. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://sunng87.github.io/blog//blog/2009/12/21/use-yan-in-ruby-web-application">
  <link href="/blog/favicon.png" rel="icon">
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/blog/atom.xml" rel="alternate" title="车水马龙" type="application/atom+xml">
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/blog/">车水马龙</a></h1>
  
    <h2>here comes the sun</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/blog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:sunng87.github.io/blog/" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/blog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Using Yan in Ruby Web Application</h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-12-21T00:00:00+08:00" pubdate data-updated="true">Dec 21<span>st</span>, 2009</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>I will show you the usage of Yan captcha service. In this tutorial, it&#8217;s based on a simple ruby web application of the Sinatra web framework.</p>

<p>Before we start to use the service, it is necesary to get Yan running. Download the code from <a href="http://bitbucket.org/sunng/yan/" target="_blank">the project page</a>, then build and run it with maven:
<em>mvn jetty:run</em></p>

<p>To enable the application to use Yan, we have to register our application to get an API Key. If you use Yan 0.3, there is a secret registration page at <em>http://localhost:8080/yan/reg.jsp</em> The page is protected by HTTP Basic Authentication, the username and password are store in &#8216;realm.properties&#8217; which is considered to locate in the root directory. Open the file you can see the plain text username and password. If you are running the latest development version, there is no long any UI for API Key creation, but restful interface. This won&#8217;t be hard to you, pickup your tools such as curl or poster (a firefox extension) to send a HTTP request. Take curl as example, do it like this:
<em>curl -X PUT &#8220;http://localhost:8080/yan/apikey/&#8221; -d &#8220;SinatraTestApp&#8221; -u &#8220;username:password&#8221;</em></p>

<p>If it works, you will get a line of json:
<em>{&#8220;apikey&#8221;:&#8221;b251b0dc2eed31cac38555b61d4fa6a453923bfd&#8221;,&#8221;appName&#8221;:&#8221;SinatraTestApp&#8221;}</em>
Save this apikey.</p>

<p>Sinatra is generally considered to be the world&#8217;s lightest and smallest web framework. And our application is rather simple. Just check the code:
<pre class="brush:ruby">require "rubygems"
require "sinatra"
require "net/http"
require "yaml"</pre></p>

<p>apikey=&#8217;b251b0dc2eed31cac38555b61d4fa6a453923bfd&#8217;</p>

<p>get &#8216;/&#8217; do<br />
	conn = Net::HTTP.new(&#8216;localhost&#8217;, 8080)<br />
	q = &#8220;ip=#{@env[&#8216;REMOTE_ADDR&#8217;]}&amp;apikey=#{apikey}&amp;alt=yaml&amp;mode=0&#8221;<br />
	resp, data = conn.get(&#8220;/yan/ticket?#{q}&#8221;)<br />
	@ticket = YAML::load(data)<br />
	haml :sinatra_captcha<br />
end</p>

<p>post &#8216;/&#8217; do<br />
	conn = Net::HTTP.new(&#8216;localhost&#8217;, 8080)<br />
	q = &#8220;ip=#{@env[&#8216;REMOTE_ADDR&#8217;]}&amp;apikey=#{apikey}&amp;key=#{params[&#8216;key&#8217;]}&amp;code=#{params[&#8216;captcha&#8217;]}&#8221;<br />
	resp, data = conn.get(&#8220;/yan/validate?#{q}&#8221;)<br />
	data<br />
end</p>

<p>use_in_file_templates!<br />
__END__</p>

<p>@@ sinatra_captcha<br />
%html<br />
	%head<br />
		%title Yan Captcha on Sinatra<br />
	%body<br />
		%form{:action=&gt;&#8221;/&#8221;, :method=&gt;&#8221;post&#8221;}<br />
			%p<br />
				Username:<br />
				%input{:name=&gt;&#8221;username&#8221;, :type=&gt;&#8221;text&#8221;}<br />
			%p<br />
				Password:<br />
				%input{:name=&gt;&#8221;password&#8221;, :type=&gt;&#8221;password&#8221;}<br />
			%p<br />
				Captcha:<br />
				%img{:src=&gt;@ticket[&#8216;url&#8217;]}<br />
				%br<br />
				%input{:name=&gt;&#8221;captcha&#8221;, :type=&gt;&#8221;text&#8221;}<br />
				%input{:name=&gt;&#8221;key&#8221;, :type=&gt;&#8221;hidden&#8221;, :value=&gt;@ticket[&#8216;key&#8217;]}<br />
				%input{:type=&gt;&#8217;submit&#8217;}

There are two parts of this application: ruby code and haml. I just use in-file-template for convenience. We define a get handler and a post handler on the path &#8216;/&#8217;. The get handler will request a ticket from Yan which contains captcha image url and ticket key. The post handler will extract user input and submit the Yan&#8217;s validator and return user the result. And the HAML code is template for page rendering after GET request.</p>

<p>Maybe you need to install sinatra and some dependency:
<em>sudo gem install sinatra haml</em></p>

<p>Run the code with a build-in WEBrick
<em>ruby sinatra-yan.rb</em></p>

<p>Browse to the default url, test it:</p>

<p><img class="alignnone" src="http://farm3.static.flickr.com/2766/4203612734_3237ed066c_o.png" alt="" width="459" height="268" /></p>

<p>For another similar tutorial using python, check Yan&#8217;s wiki page:
<a href="http://bitbucket.org/sunng/yan/wiki/SampleCode" target="_blank">http://bitbucket.org/sunng/yan/wiki/SampleCode</a></p>

<p>Thank you for your support. btw, today is my dear girl friend&#8217;s birthday, I just wish her happy everyday.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Sun Ning</span></span>

      








  


<time datetime="2009-12-21T00:00:00+08:00" pubdate data-updated="true">Dec 21<span>st</span>, 2009</time>
      

<span class="categories">
  
    <a class='category' href='/blog/blog/categories/ba-xi/'>把戏</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="/blog//twitter.com/share" class="twitter-share-button" data-url="http://sunng87.github.io/blog//blog/2009/12/21/use-yan-in-ruby-web-application/" data-via="Sunng" data-counturl="http://sunng87.github.io/blog//blog/2009/12/21/use-yan-in-ruby-web-application/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/blog/2009/12/20/yan-0-3/" title="Previous Post: Yan 0.3">&laquo; Yan 0.3</a>
      
      
        <a class="basic-alignment right" href="/blog/blog/2009/12/22/%E4%B8%8A%E6%B5%B7%E5%9B%BE%E4%B9%A6%E9%A6%86/" title="Next Post: 上海图书馆">上海图书馆 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/blog/2013/07/05/grunt-for-requirejs-projects/">Grunt for Requirejs Projects</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/06/29/%E7%BB%99-raspberry-pi-%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AA%E6%98%BE%E7%A4%BA-ip-%E7%9A%84%E6%B6%B2%E6%99%B6%E5%B1%8F/">给 Raspberry Pi 添加一个显示 IP 的液晶屏</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/06/07/%E7%BA%B8%E4%B8%8A%E5%BE%97%E6%9D%A5%E7%BB%88%E8%A7%89%E6%B5%85/">纸上得来终觉浅</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/04/24/checkout-ring-adapter-for-jetty-9/">Checkout Ring Adapter for Jetty 9</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/04/12/ann-handlebars-clojure-api/">[ANN] Handlebars Clojure API</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/sunng87">@sunng87</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'sunng87',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/blog/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>On Delicious</h1>
  <div id="delicious"></div>
  <script type="text/javascript" src="http://feeds.delicious.com/v2/json/classicing?count=3&amp;sort=date&amp;callback=renderDeliciousLinks"></script>
  <p><a href="http://delicious.com/classicing">My Delicious Bookmarks &raquo;</a></p>
</section>




  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Sun Ning -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'sunng-blog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://sunng87.github.io/blog//blog/2009/12/21/use-yan-in-ruby-web-application/';
        var disqus_url = 'http://sunng87.github.io/blog//blog/2009/12/21/use-yan-in-ruby-web-application/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
