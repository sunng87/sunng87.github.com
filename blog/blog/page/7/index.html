
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Here comes the Sun</title>
  <meta name="author" content="Sun Ning">

  
  <meta name="description" content="An interceptor framework was introduced in slacker 0.3.0. It&#8217;s designed to allow user to add custom functionality without hacking into the &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://sunng87.github.io/blog//blog/page/7">
  <link href="/blog/favicon.png" rel="icon">
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/blog/atom.xml" rel="alternate" title="Here comes the Sun" type="application/atom+xml">
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/blog/">Here comes the Sun</a></h1>
  
    <h2>Sun Ning's web log</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/blog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:sunng87.github.io/blog/" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/blog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2011/12/18/extend-slacker-server-with-interceptors/">Extend Slacker Server With Interceptors</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-18T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>An interceptor framework was introduced in slacker 0.3.0. It&#8217;s designed to allow user to add custom functionality without hacking into the internal of slacker.</p>

<p>Like many server frameworks, slacker abstracts the request processing as a pipeline. The request object is modified by adding or updating attributes through each node of the pipeline. So it&#8217;s easy to add your interceptor into the pipeline, with which you can get the data before and after function executed.</p>

<p>To create such an interceptor, you should use the <em>slacker.interceptor/definterceptor</em> macro and <em>slacker.interceptor/definterceptor+</em> macro:</p>

<p><blockquote>(definterceptor name<br />
  :before interceptor-function<br />
  :after interceptor-function)</blockquote></p>

<p><blockquote>(definterceptor+ name [arguments]<br />
  :before interceptor-function<br />
  :after interceptor-function)</blockquote></p>

<p>definterceptor+ can accept arguments so you can configure the interceptor when you use it.</p>

<p>See a simple example:<br />
[cc lang=&#8221;clojure&#8221;]<br />
(definterceptor log-function-call<br />
  :before (fn [req] (println (str &#8220;calling &#8221; (:fname req))) req))</p>

<p>(definterceptor+ log-function-call-prefixed [prefix]<br />
  :before (fn [req] (println (str <br />
                               (if (fn? prefix) (prefix) prefix) <br />
                               &#8221; calling &#8221; <br />
                               (:fname req))) <br />
                    req))<br />
[/cc]</p>

<p>Then, add it to your slacker server by<br />
[cc lang=&#8221;clojure&#8221;]<br />
(use &#8216;[slacker.interceptor])<br />
(import &#8216;[java.util Date])<br />
(start-slacker (the-ns &#8216;slapi) 2104<br />
  :interceptors (interceptors log-function-call<br />
                              (log-function-call-prefixed <br />
                                (fn [] (.toString (Date.)))))<br />
[/cc]</p>

<p>Now you can log every function call of your slacker server.</p>

<p>For more detail about the interceptor framework, especially the request data, please check the <a href="https://github.com/sunng87/slacker/wiki/Interceptors" target="_blank">wiki page</a>.</p>

<p>In slacker 0.3.0, there is a built-in interceptor to stats function calls. You can find it at <em>slacker.interceptors.stats</em>. The stats data is expose via JMX. You can also write monitoring application to retrieve the data. 
<a href="http://imgur.com/vtOoL"><img src="http://i.imgur.com/vtOoL.png" alt="" title="Hosted by imgur.com" /></a></p>

<p>And there will be more built-in interceptors in 0.4.0, includes function call time stats and logging.</p>

<p></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2011/12/16/%E4%BD%BF%E7%94%A8clojure-thread-macro%E7%9A%84%E5%BF%83%E5%BE%97/">使用Clojure Thread Macro的心得</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-16T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Thread Macro是clojure里一个很强大的宏，他帮助你简化嵌套函数的调用，比如<br />
[cc lang=&#8221;clojure&#8221;]<br />
(str (inc (count [:a :b])))<br />
[/cc]<br />
就可以利用thread macro简写成<br />
[cc lang=&#8221;clojure&#8221;]<br />
(-> [:a :b] count inc str)<br />
[/cc]</p>

<p>-&gt;&gt;和-&gt;类似，区别在于-&gt;&gt;把值作为函数的最后一个参数传入。</p>

<p>简单的功能介绍完了，接下来就遇到问题了。我需要功能，能够接受一个或多个函数，然后把这些函数组成一个pipeline。这时很自然想到-&gt;是一个好帮手。也许只需要一个类似这样的form就可以了： #(apply -&gt; % [funcs])。结果失败了，因为-&gt;是个宏，所以根本不能用apply。于是想到有apply-macro吗？有，或者说曾经有过。在contrib中曾经有一个apply-macro，不过被强烈不推荐使用。到这里，这条路堵死了，惟一的办法就是把-&gt;放到API之外，放到用户代码里去。</p>

<p>放到用户代码里，你需要写一个详细的说明文档并且告诉用户他必须这么做。然而在clojure世界里有一个更好的办法就是再写一个宏把-&gt;包装起来。这么做看似多此一举，其实是保持了API的一致性。通过宏，我们可以把自己的API延伸到用户代码中去。或者说，通过一个类似DSL的宏，给一些并不优雅的API一个缓冲，也为API日后的演化留下空间。</p>

<p>这里还要扯开一句关于宏的开发。clojure中所谓code is data，主要就是体现在宏里。原本在多数其他语言里，宏是不能求值的。但是在clojure里，由于code is data的缘故，宏是可以求值的。所有的输入数据都是list，你可以做first/reverse这样的操作。但是有一点要注意的是，宏中求得的值和代码里的值是不一样的。例如{:a inc}这样一个字面量，在宏里是可以通过:a做求值的，然后这里得到的并非一个函数（function），而是一个符号（symbol）。再者，调试宏的时候你可能会被这样的结果困惑：<br />
[cc lang=&#8221;clojure&#8221;]<br />
(defmacro a [f] (println (:a f)))<br />
(a {:a 1}) ; ==> prints 1<br />
(def b {:a 1})<br />
(a b) ; ==> prints nil<br />
[/cc]<br />
字面量可以，同值的变量就不行了。原因还是那句，宏里不能求值。</p>

<p>继续谈-&gt;。这个宏其实远没有你想象的那么驯服。遇到复杂一点的情况：<br />
[cc lang=&#8221;clojure&#8221;]<br />
(def m {:a inc})<br />
(-> 2 (get m :a) str)<br />
[/cc]<br />
这个写法对吗？str是个函数，(get m :a)返回的是inc也是个函数，貌似正确。运行之后却报错get的参数数量错误。所以千万不要忘了-&gt;是个宏，(get m :a)这里是不会求值到inc的，直接作为一个list被宏吞下去。在宏里只能通过符号的组合变化来生成代码，那么一不小心，就没有inc什么事了。</p>

<p>于是，你可能想到这里需要一个确切的函数，就好比这样：<br />
[cc lang=&#8221;clojure&#8221;]<br />
(def m {:a inc})<br />
(-> 2 (fn [x] ((get m :a) x)))<br />
[/cc]<br />
也许这样就好多了，我们放了一个匿名函数，并不要求宏去求值，因为这个匿名函数会被宏生成到新的代码里。里面的get也会在运行时求值。看似没什么问题，可是一运行还是没有期待的结果，居然返回了一个匿名函数！而对这个匿名函数求值得到的也是一个错误的结果！简直有点无厘头了。</p>

<p>呵呵，不故弄玄虚了。我们用macroexpand看看发生了什么。</p>

<p>这是用匿名函数包装以前<br />
[cc lang=&#8221;clojure&#8221;]<br />
(macroexpand-1 &#8216;(-> 2 (get m :a)))<br />
(get 2 m :a)<br />
[/cc]<br />
-&gt;居然只是简单地把2放到了get这个form里面！</p>

<p>再看看用匿名函数包装后的结果<br />
[cc lang=&#8221;clojure&#8221;]<br />
(macroexpand-1 &#8216;(-> 2 (fn [x] ((get m :a) x))))<br />
(fn 2 [x] ((get m :a) x))<br />
[/cc]<br />
和刚才一样，2被放到了第一个form的第一个参数位置！得到的是一个非法的form。</p>

<p>那么既然-&gt;只是简单地把第一个参数放到后面form的首个参数的位置，那么这个宏正确的使用方法其实是<br />
[cc lang=&#8221;clojure&#8221;]<br />
(def m {:a inc})<br />
(-> 2 ((fn [x] ((get m :a) x))))<br />
[/cc]<br />
再加一层括号！<br />
[cc lang=&#8221;clojure&#8221;]<br />
(macroexpand-1 &#8216;(-> 2 ((fn [x] ((get m :a) x)))))<br />
((fn [x] ((get m :a) x)) 2)<br />
[/cc]</p>

<p>可见，-&gt;虽然是个功能强大的宏，但宏终归只是宏，和函数的区别是明显的。在使用的时候，不能完全按照函数的习惯。</p>

<p>如果你想了解实际的代码，可以参考slacker 0.3.0里的这个interceptor框架：
<a href="https://github.com/sunng87/slacker/blob/master/src/slacker/interceptor.clj" target="_blank">https://github.com/sunng87/slacker/blob/master/src/slacker/interceptor.clj</a>
上面提到的难处，多半也都是在开发这个框架时亲身经历的。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2011/12/10/slacker-0-2-0-is-out/">Slacker 0.2.0 Is Out</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-10T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://github.com/sunng87/slacker">Slacker 0.2.0</a> has been pushed to clojars today. Connection pooling and json serialization are available in this release.</p>

<p><h4>Connection Pool</h4>
Generally, pooling connection is a good idea in high concurrence application. To make slacker for real world, connection pool support is a high-prioritized feature in its development. The new connection pool is backended by commons-pool which you might familiar with. To use connection pool, just create slacker client with a new function `slackerc-pool`</p>

<p>[cc lang=&#8221;clojure&#8221;]<br />
(def scp (slackerc-pool &#8220;localhost&#8221; 2104))<br />
[/cc]</p>

<p>Then you can use this pool just like a single client.</p>

<p>Some options are available to configure the pool by your wish:
<ul>
	<li><em>:max-active</em>, max connections opened by the pool</li>
	<li><em>:exhausted-action</em> <br />
            <ul>
               <li><em>:fail</em> throw an exception when pool exhausted.</li>
<li><em>:block</em> block current thread and wait until max-wait exceed (throw an exception)</li>
	<li><em>:grow</em> automatically create new connection and add it to pool</li></ul></li></ul></p>

<p>            
<li><em>:max-wait</em> max wait time before throwing an exception</li>
	<li><em>:min-idle</em> minimal number of pool hold idle connections </li></p>

<p>
The options are inherited from GenericObjectPool, you can find detailed information from their <a href="http://commons.apache.org/pool/apidocs/org/apache/commons/pool/impl/GenericObjectPool.html">javadoc</a>.</p>

<p><h4>JSON Serialization</h4>
slacker just added json serialization provided by clj-json. According to my test, clj-json is 1x faster than carbonite in serialization. <br />
[cc lang=&#8221;clojure&#8221;]<br />
(def sc (slackerc &#8220;localhost&#8221; 2104 :content-type :json))<br />
[/cc]</p>

<p>However, with json serialization, you may lost some clojure types like keyword and set in type conversion. You should be caution when using json as serialization method. </p>

<p>In next release, I am planning to use <a href="https://github.com/AlibabaTech/fastjson/" target="_blank">fastjson</a> as json lib which provides option to write type name into json so it could be a full featured serialization for clojure. And fastjson is claimed even faster than jackson.</p>

<p><h4>Performance</h4>
slacker gains high performance with its non-blocking server, serialization and direct function call. As tested on a dual 6 core server,  it reaches 10000+ TPS for a single client (50 connections, 50 threads). The server just use 35% CPU so I consider it could have even more TPS if there is two or more client machines.</p>

<p>So if you are interested in some benchmarks, you can test it with client like <a href="https://gist.github.com/1449860" target="_blank">this</a>. All the requests are using synchronous call because I believe it&#8217;s the most common case you use slacker.</p>

<p><h4>Next steps</h4>
Inspired by discussion in <a href="http://groups.google.com/group/cn-clojure" target="_blank">cn-clojure</a> mailing list, I&#8217;m going to add HTTP transport for slacker. With HTTP transport, it&#8217;s easier to debug and evaluate your clojure functions, it also makes slacker available to ClojureScript. </p>

<p>At lst, thanks Zach Tellman for reviewing my client code. 
</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2011/12/03/%E4%BB%8Egnome%E7%BD%91%E7%AB%99%E5%AE%89%E8%A3%85exaile-doubanfm-gnome-shell-extension/">从GNOME网站安装exaile-doubanfm-gnome-shell-extension</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-03T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近GNOME发布了期待已久的extension.gnome.org，这个网站允许你直接通过浏览器安装和管理gnome-shell扩展，有点类似app store的感觉，混乱的~/.local/share/gnome-shell/extensions/终于有了一个官方的界面。</p>

<p>网站开通的第一时间，我提交了exaile-doubanfm-gnome-shell-extension，经过review和修改，这个扩展也得到了进一步的完善，适配了gnome-shell 3.2的风格。</p>

<p>你可以从这个地址直接安装启用
<a href="https://extensions.gnome.org/extension/24/exaile-doubanfm-control/" target="_blank">https://extensions.gnome.org/extension/24/exaile-doubanfm-control/</a></p>

<p>它会在exaile douban.fm启动后显示一个菜单在gnome-shell上，你可以通过这个菜单进行基本的操作。</p>

<p>如果喜欢，别忘了在extension.gnome.org上vote一下 ：）</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2011/12/02/slacker-0-1-0-is-out/">Slacker 0.1.0 Is Out</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-02T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Glad to roll out the first release of the <strong>slacker</strong> framework. Slacker is a clojure RPC framework on top of a TCP binary protocol. It provides a set of non-invasive APIs for both server and client. The remote invocation is completely transparent to user.</p>

<p>In addition to APIs introduced in <a href="http://sunng.info/blog/2011/11/clojure-rpc-prototyping-and-early-thoughts/">last post</a>, asynchronous approach is supported in client API :<br />
[cc lang=&#8221;clojure&#8221;]<br />
(defremote remote-func :async true)<br />
@(remote-func)<br />
[/cc]<br />
If you add option `:async` to defremote, then the function facade will return a promise. You have to deref it by yourself. Also you can use the `:callback` option in defremote to specify a callback function.<br />
[cc lang=&#8221;clojure&#8221;]<br />
(defremote remote-func :callback #(println %))<br />
(remote-func)<br />
[/cc]</p>

<p>This gives you much more flexibility of using remote function. But be careful it will break consistency between local and remote mode. </p>

<p>To use slacker, add it to your project.clj<br />
[cc lang=&#8221;clojure&#8221;]<br />
:dependencies [[info.sunng/slacker &#8220;0.1.0&#8221;]]<br />
[/cc]</p>

<p>You can find examples on the <a href="https://github.com/sunng87/slacker" target="_blank">github page</a>. </p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2011/12/01/exaile%E8%B1%86%E7%93%A3%E7%94%B5%E5%8F%B0%E6%8F%92%E4%BB%B60-0-11%E5%8F%91%E5%B8%83/">Exaile豆瓣电台插件0.0.11发布</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-01T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>很高兴时隔半年后我继续发布了Exaile豆瓣电台插件的更新，从第一个版本发布到现在已经有一年半的时间，这期间豆瓣电台插件已经陆续出现在Rhythmbox、Banshee等播放器上。作为第一个视图把豆瓣电台移植到本地的尝试，我感到甚是欣慰：）</p>

<p>这次的更新修正了长久依赖困绕用户登录问题，现在我们有一个专门的界面来输入验证码。这个功能要感谢<a href="https://github.com/sunng87/exaile-doubanfm-plugin/issues/8">DigitalPig</a>用户在github的报告（鞭策作用），此外，我参考了<a href="http://code.google.com/p/banshee-doubanfm/">豆瓣电台banshee插件</a>的实现，节省了研究含验证码登录的时间，感谢。总而言之，没有用户的推动，这个项目也不会坚持这么久。
<img src="http://i.imgur.com/cYNrM.png" alt="" /></p>

<p>除此之外，插件还有一些支持了新的豆瓣说的推荐，优化了播放列表载入的策略。</p>

<p>另外值得highlight的是，对应的gnome-shell扩展发布了0.0.2版本，唯一的更新是专辑封面现在会显示在gnome-shell的菜单中。
<img src="http://i.imgur.com/7Q1CP.jpg" alt="" /></p>

<p>你可以从github获得最新的插件和gnome-shell扩展：
<ul>
<li>exaile-doubanfm-plugin 0.0.11-captcha: <a href="https://github.com/sunng87/exaile-doubanfm-plugin/downloads">https://github.com/sunng87/exaile-doubanfm-plugin/downloads</a></li>
<li>exaile-doubanfm-gnome-shell-extension 0.0.2: <a href="https://github.com/sunng87/exaile-doubanfm-gnome-shell-extension/tarball/0.0.2">https://github.com/sunng87/exaile-doubanfm-gnome-shell-extension/tarball/0.0.2</a></li></ul></p>

<p>安装豆瓣电台插件请参考<a href="https://github.com/sunng87/exaile-doubanfm-plugin/wiki/Installation">这里</a>。gnome-shell扩展直接解压至~/.local/share/gnome-shell/extensions/即可
</p>

<p>有任何问题都可以在github或这里留言。
</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2011/11/27/clojure-rpc-prototyping-and-early-thoughts/">Clojure RPC, Prototyping and Early Thoughts</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-27T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Last week, I prototyped an RPC framework, <a href="https://github.com/sunng87/slacker" target="_blank">slacker</a>, by clojure and for clojure. </p>

<p><h3>What I did ?</h3>
Suppose you have a sets of clojure functions to expose. Define them under a namespace:<br />
[cc lang=&#8221;clojure&#8221;]<br />
(ns slapi)<br />
(defn timestamp []<br />
  (System/currentTimeMillis))</p>

<p>;; &#8230;more functions<br />
[/cc]</p>

<p>Expose the namespace with slacker server, on port 2104:<br />
[cc lang=&#8221;clojure&#8221;]<br />
(use &#8216;slacker.server)<br />
(start-slacker-server (the-ns &#8216;slapi) 2104)[/cc]</p>

<p>On the client side, we use the `defremote` macro to create a facade for `timestamp` function. This API will keep the client code consistent with local mode.<br />
[cc lang=&#8221;clojure&#8221;]<br />
(use &#8216;slacker.client)<br />
(def sc (slackerc &#8220;localhost&#8221; 2104))<br />
(defremote sc timestamp)<br />
(timestamp)<br />
[/cc]</p>

<p>Internally, slacker uses <a href="https://github.com/ztellman/aleph" target="_blank">aleph</a> for transport and <a href="https://github.com/revelytix/carbonite" target="_blank">carbonite</a> for serialization. I forked carbonite and made it compatible with clojure 1.2 because the aleph mainline is still running on 1.2. </p>

<p><h3>Going further</h3>
<h4>High-Order Functions</h4>
In clojure, functions are treated as first class value. Within memory, you can pass function as parameter to another function. However, this is not supported by serialization framework. So is it possible to add support for that in future?</p>

<p><h4>Lazy sequence as parameter</h4>
This is another interesting feature in clojure function call. You can pass a lazy-sequence to clojure function. In RPC, it requires parameters to be evaluated on the server side.<br />
[cc lang=&#8221;clojure&#8221;]<br />
(defn get-first [& args] (first args))<br />
(apply get-first (range))<br />
[/cc]<br />
Example copied from <a href="http://stackoverflow.com/q/8205446/371141" target="_blank">StackOverflow</a></p>

<p><h4>Coordinated states between several remote servers</h4>
With RPC, we can update states on several servers. So do we need something like distributed dosync:<br />
[cc lang=&#8221;clojure&#8221;]<br />
(defremote a1 update-a1-state)<br />
(defremote a2 update-a2-state)<br />
(dosync-distributed<br />
  (update-a1-state some-value)<br />
  (update-a2-state some-value))<br />
[/cc]<br />
I&#8217;m not sure if this is a valid scenario in real world but I think it&#8217;s an interesting topic.(distributed STM?)</p>

<p><h3>Conclusion</h3>
RPC is the first step to distributed clojure world. I will keep you updated with my prototype. 
</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2011/11/19/spark-in-common-lisp/">Spark in Common Lisp</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-19T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>还是关于spark的，一石激起千层浪，每个人心中都有一个spark。其实spark脚本刚出来的时候问题很多，但是就是因为产生了共鸣，众人拾柴pull request多。像redis的作者antirez也忍不住自己用c写了一个<a href="https://github.com/antirez/aspark" target="_blank">aspark</a>。</p>

<p>说完了别人的，那么来看看我的：clspark，common-lisp的spark。原本是打算用clojure写，但是想到jvm的启动速度，把这个机会留给我的第一个common lisp程序吧。</p>

<p><img src="http://i.imgur.com/oD7m4.png" alt="" /></p>

<p>其实很简单。
<script src="https://gist.github.com/1375401.js"> </script></p>

<p>common lisp的核心库里没有split，所以这里从cl-cookbook拷贝了一个split的实现，坦白说我还看不太懂这个loop的写法。loop是common lisp中最尴尬的form，因为他的形式太多。这点在clojure中是不存在的。比较一下就能发现，在语言层面，clojure是相对现代得多的lisp方言。
</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2011/11/16/my-response-to-spark-visualize-your-mercurial-commit-history-from-commandline/">My Response to Spark: Visualize Your Mercurial Commit History From Commandline</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-16T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>标题长了些。还是用母语吧。</p>

<p>昨天HackerNews上一个<a href="http://news.ycombinator.com/item?id=3237478" target="_blank">小脚本</a>轰动了，所谓山不在高程序不在小。为了响应这个小脚本，我写了一个更加简单的Mercurial(hg)扩展，帮助你输出hg仓库的提交历史。这个feature和github的直方图有点像，在我看来github的直方图是他们最重要的feature之一，它鞭策着你不断地commit。</p>

<p><img src="http://i.imgur.com/ZcEfH.png" alt="hg summary" /></p>

<p><script src="https://gist.github.com/1366606.js"> </script></p>

<p>安装:将这个脚本放在任意一处，在你的hgrc中添加：<br />
[cc lang=&#8221;text&#8221;]<br />
[extensions]<br />
summary = /path/to/your/script<br />
[/cc]</p>

<p>由于很简单，就不按照mercurial的规范发布了。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2011/11/04/%E5%86%8D%E8%A7%812011%E8%B5%9B%E5%AD%A3/">再见2011赛季</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-04T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>虽然还有两个月才能结束这个2011年，但是舜天队的赛季已经结束了。经过大半年的鏖战，大起大落之后，最终球队取得了史无前例的第四名，这让我们看了十多年次级联赛的球迷一时间几乎无法接受。今年赶在联赛开始前我换工作回到南京，去主场的机会也比以前上学或是在外地时多了很多，最终今年一共看了6个主场，是看球16年以来最多的一年。当然不出意外明年还要刷新这个纪录！</p>

<p>周三下午请假去球场目送了一下球队。距离明年开赛还有5个月，有一些球员可能转会，有的退役，所以每到最后一轮都是伤离别的时候。只是往年，这个时候都是夕阳西下，三三两两的观众看完无关紧要的比赛鸟兽散去；而今年的最后一轮，我们还为了理论上的一个亚冠机会争取。</p>

<p>2009年加入球队，2011年学习回来后，杨晨是舜天队的领队兼助理教练。在比赛开始前，作为助理教练要带领队员作热身活动。
<a href="http://www.flickr.com/photos/40741608@N08/6305940310/" title="resized-DSC_0017 by 贝小塔, on Flickr"><img src="http://farm7.static.flickr.com/6059/6305940310_4497b80191.jpg" width="500" height="335" alt="resized-DSC_0017" /></a></p>

<p>队员训练。
<a href="http://www.flickr.com/photos/40741608@N08/6305939050/" title="resized-DSC_0011 by 贝小塔, on Flickr"><img src="http://farm7.static.flickr.com/6102/6305939050_01fa72bf36.jpg" width="500" height="335" alt="resized-DSC_0011" /></a>
前面两位是去年从降级的长沙金德转投而来的刘建业和任航，刘建业现在也是队里唯一的国脚。两人转会过来以后一直是球队的主力。刘建业负责中场的拦截防守；任航是边后卫，可以胜任左右两边，攻防俱佳。<br />
跟在后面的时候杜文辉和李炽。杜文辉上赛季结束后被国安队清洗，自由转会来到舜天本来希望通过更多的出场机会能获得国家队的席位，结果不料第四轮就重伤缺席了后面的比赛。复出后球队已经更换了教练，不过杜文辉还是舜天队里技术顶尖的球员，经历了一番周折到了赛季末他还是占据了主力的位置。后面李炽是队龄最大的队员之一，2005年从广东来到江苏，伴随球队度过了最艰难的05、06、07年。升级之后，李炽一直在主力和替补之间徘徊，不过最后总能通过努力获得首发的机会。今年李炽合同到期，据说一条微博还让很多球迷以为下赛季他会回到广东，为此，有了这么一条横幅：
<a href="http://www.flickr.com/photos/40741608@N08/6305965870/" title="resized-DSC_0057 by 贝小塔, on Flickr"><img src="http://farm7.static.flickr.com/6112/6305965870_54acc94e94.jpg" width="500" height="335" alt="resized-DSC_0057" /></a></p>

<p><a href="http://www.flickr.com/photos/40741608@N08/6305417351/" title="resized-DSC_0035 by 贝小塔, on Flickr"><img src="http://farm7.static.flickr.com/6119/6305417351_604711e9d3.jpg" width="500" height="335" alt="resized-DSC_0035" /></a>
中间的9号陆博飞是球队的队长，在球场上的角色有点类似皮尔洛。今年陆队已经32岁了，不过据他昨天在广播里说他的状态还可以再踢两年。20号孙可是队里唯一一个能打上主力的由舜天梯队培养出来的队员，今年孙可也经历了最重要的一个赛季，基本上完成了从替补到主力的转换，在比赛中的作用也越来越重要。</p>

<p>罗马尼亚人达纳拉赫，这位仁兄上半赛季经历了漫长的进球荒，如果不是在场上特别积极，恐怕早就收拾东西走人了。好在从对陕西开和之后，状态越来越好，最终打进13球，在射手榜上排到了第三。
<a href="http://www.flickr.com/photos/40741608@N08/6305413781/" title="resized-DSC_0002 by 贝小塔, on Flickr"><img src="http://farm7.static.flickr.com/6221/6305413781_52b509b2ff.jpg" width="335" height="500" alt="resized-DSC_0002" /></a></p>

<p>达纳拉赫的诡异爆发得益于身边空降了一名优秀的同伴，塞尔维亚红星队的耶夫迪奇夏季转会来到球队，是球队历史上身价最高的球员（140万美元）。身价在总体上当然还是和能力成正比的，耶夫迪奇半个赛季就打进11个球，是球队在场上最重要的球员。
<a href="http://www.flickr.com/photos/40741608@N08/6305414451/" title="resized-DSC_0005 by 贝小塔, on Flickr"><img src="http://farm7.static.flickr.com/6048/6305414451_091646b612.jpg" width="335" height="500" alt="resized-DSC_0005" /></a></p>

<p>后防线上，两个外援塔基耶夫（左）和埃雷尔森（右）。前者是乌兹别克国脚，他的哥哥和弟弟都曾经在天津泰达踢球。后者是球队的老面孔，埃雷尔森从09年就加入球队，一直是后防线上的定海神针，今年也是联赛中的最佳后卫。
<a href="http://www.flickr.com/photos/40741608@N08/6305445957/" title="resized-DSC_0097 by 贝小塔, on Flickr"><img src="http://farm7.static.flickr.com/6056/6305445957_78408799d4.jpg" width="335" height="500" alt="resized-DSC_0097" /></a></p>

<p>守门员邓小飞也是09年加入球队，前半赛季一直是替补，后来成为主力之后发挥一直很出色，也是球队后半赛季辉煌的功臣。
<a href="http://www.flickr.com/photos/40741608@N08/6305939562/" title="resized-DSC_0013 by 贝小塔, on Flickr"><img src="http://farm7.static.flickr.com/6120/6305939562_29166f6ca4.jpg" width="500" height="335" alt="resized-DSC_0013" /></a></p>

<p><a href="http://www.flickr.com/photos/40741608@N08/6305943262/" title="resized-DSC_0050 by 贝小塔, on Flickr"><img src="http://farm7.static.flickr.com/6056/6305943262_28b08f9c4e.jpg" width="500" height="335" alt="resized-DSC_0050" /></a>
替补席上的秘鲁外援略显落寞，因为在球队没有位置明年他将是唯一一名离队的外援，所以也有球迷专门给他感谢
<a href="http://www.flickr.com/photos/40741608@N08/6305440759/" title="resized-DSC_0054 by 贝小塔, on Flickr"><img src="http://farm7.static.flickr.com/6045/6305440759_dbc9cdef90.jpg" width="500" height="335" alt="resized-DSC_0054" /></a></p>

<p><a href="http://www.flickr.com/photos/40741608@N08/6305441949/" title="resized-DSC_0066 by 贝小塔, on Flickr"><img src="http://farm7.static.flickr.com/6220/6305441949_1b27db51ee.jpg" width="500" height="335" alt="resized-DSC_0066" /></a>
<a href="http://www.flickr.com/photos/40741608@N08/6305967488/" title="resized-DSC_0071 by 贝小塔, on Flickr"><img src="http://farm7.static.flickr.com/6038/6305967488_acaf5953e0.jpg" width="500" height="335" alt="resized-DSC_0071" /></a>
<a href="http://www.flickr.com/photos/40741608@N08/6305966894/" title="resized-DSC_0067 by 贝小塔, on Flickr"><img src="http://farm7.static.flickr.com/6054/6305966894_b9c252503e.jpg" width="500" height="335" alt="resized-DSC_0067" /></a>
<a href="http://www.flickr.com/photos/40741608@N08/6305444653/" title="resized-DSC_0086 by 贝小塔, on Flickr"><img src="http://farm7.static.flickr.com/6223/6305444653_dcae78f290.jpg" width="500" height="335" alt="resized-DSC_0086" /></a>
<a href="http://www.flickr.com/photos/40741608@N08/6305446603/" title="resized-DSC_0099 by 贝小塔, on Flickr"><img src="http://farm7.static.flickr.com/6220/6305446603_d947877f41.jpg" width="335" height="500" alt="resized-DSC_0099" /></a>
<a href="http://www.flickr.com/photos/40741608@N08/6305444149/" title="resized-DSC_0079 by 贝小塔, on Flickr"><img src="http://farm7.static.flickr.com/6099/6305444149_d4f47a20f9.jpg" width="500" height="335" alt="resized-DSC_0079" /></a>
比赛最终没有什么悬念地结束，虽然球队没有获得亚冠的名额，不过今年的成绩已经是18年历史上最佳排名。
<a href="http://www.flickr.com/photos/40741608@N08/6305971668/" title="resized-DSC_0105 by 贝小塔, on Flickr"><img src="http://farm7.static.flickr.com/6049/6305971668_046a4e5e6b.jpg" width="500" height="335" alt="resized-DSC_0105" /></a>
球迷聚在场外放完烟火，约定明年再战！
<a href="http://www.flickr.com/photos/40741608@N08/6305447755/" title="resized-DSC_0127 by 贝小塔, on Flickr"><img src="http://farm7.static.flickr.com/6091/6305447755_90a5a74ebb.jpg" width="500" height="335" alt="resized-DSC_0127" /></a></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/blog/page/8/">&larr; Older</a>
    
    <a href="/blog/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/blog/page/6/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p>Programmer. Map enthusiast. (<a href="http://sunng.info/">more</a>)</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/blog/2014/05/27/fork-join-in-papaline/">Fork-Join in Papaline</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2014/04/20/concurrent-pipeline-with-core-async/">Papaline: Concurrent Pipeline With core.async</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2014/04/20/rust-concurrent-made-safely/">Rust语言：安全的并发</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2014/03/04/slacker-0-dot-11-released/">Slacker Library Updated</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/10/22/swapping-harddisk-without-pain/">Archlinux 安全更换硬盘</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/sunng87">@sunng87</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'sunng87',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/blog/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>On Delicious</h1>
  <div id="delicious"></div>
  <script type="text/javascript" src="http://feeds.delicious.com/v2/json/classicing?count=3&amp;sort=date&amp;callback=renderDeliciousLinks"></script>
  <p><a href="http://delicious.com/classicing">My Delicious Bookmarks &raquo;</a></p>
</section>




  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Sun Ning -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'sunng-blog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
