
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>车水马龙</title>
  <meta name="author" content="Sun Ning">

  
  <meta name="description" content="Amoeba is a distributed database middleware works as mysql proxy, provides sharding and high availability support for large scale applications using &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://sunng87.github.io/blog//blog/page/21">
  <link href="/blog/favicon.png" rel="icon">
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/blog/atom.xml" rel="alternate" title="车水马龙" type="application/atom+xml">
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/blog/">车水马龙</a></h1>
  
    <h2>here comes the sun</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/blog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:sunng87.github.io/blog/" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/blog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2010/08/19/introduction-to-amoeba/">Introduction to Amoeba</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-08-19T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Amoeba is a distributed database middleware works as mysql proxy, provides sharding and high availability support for large scale applications using multiple mysql servers as backend.</p>

<p>Compatible with mysql protocol, Amoeba is fully transparent to any client using standard mysql drivers, which means, to use Amoeba you don&#8217;t have to modify any code of database connector. You just configure rules for amoeba, then the client request will automatically route to certain mysql instance. Amoeba has a flexible set of configuration rules that can satisfy your requirements.</p>

<p>Amoeba is written in Java, and deployed on Linux server in most cases. The IO module is built on the top of Java nonblocking IO, which keeps communication between client, Amoeba and mysql at a high performance.</p>

<p>The project is initialized in 2008. Stable release 1.2.1-GA have been available since July, 2010 . It is now serving on the production environment of the social networks <a href="http://t.sdo.com/">http://t.sdo.com/</a></p>

<p>Project home:
<a href="http://code.google.com/p/amoeba/">http://code.google.com/p/amoeba/</a></p>

<p>Development logs:
<a href="http://amoeba.meidusa.com/wordpress/">http://amoeba.meidusa.com/wordpress/</a></p>

<p>The post is brought to you by <a href="http://fedorahosted.org/lekhonee">lekhonee</a> v0.7</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2010/08/17/geb-for-browser-functional-testing/">Geb for Browser Functional Testing</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-08-17T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>虽然现在不做前段了，但是发现好的工具还是很兴奋。今天在twitter上看到Grails in Action的作者 @pledbrook 转了一个geb 0.4的消息，顺带看了一下这个工具<br />
http://geb.codehaus.org</p>

<p>geb项目旨在创造一套groovy dsl帮助人们进行webapp的functional test。它是对selenium的封装，举例：<br />
[cc lang=&#8221;groovy&#8221;]<br />
@Grapes([<br />
    @Grab(&#8216;org.seleniumhq.selenium:selenium-firefox-driver:latest.release&#8217;),<br />
    @Grab(&#8216;org.codehaus.geb:geb-core:latest.release&#8217;)<br />
])<br />
import geb.*</p>

<p>println &#8220;Dependencies downloaded, ready for testing&#8221;<br />
Browser.drive(&#8216;http://sunng.info:8000/Pacajus&#8217;){<br />
    assert title== &#8216;Pacajus&#8217;</p>

<p>    assert $(&#8220;p&#8221;, 3).text() == &#8216;Population: 41558&#8217;<br />
}
println &#8220;Tested, bye&#8221;<br />
[/cc]</p>

<p>打开页面，执行断言。如果断言失败，driver方法会报null：<br />
Caught: geb.error.DriveException: null</p>

<p>只要在命令行用groovy执行即可，grapes会搞定依赖关系。</p>

<p>很方便吧，文档上说还可以跟grails / junit等等集成，快去看看吧
<a href="http://geb.codehaus.org/manual/latest/index.html">http://geb.codehaus.org/manual/latest/index.html</a></p>

<p>The post is brought to you by <a href="http://fedorahosted.org/lekhonee">lekhonee</a> v0.7</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2010/08/13/next-to-richard-stallman/">Next to Richard Stallman</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-08-13T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><p>我这个人一般不八卦，你知道的。但是个别时候实在是情难以堪。</p>
<p>Bug 626593 - Gnome ate my boyfriend! Help!<br />
<a href="https://bugzilla.gnome.org/show_bug.cgi?id=626593">https://bugzilla.gnome.org/show_bug.cgi?id=626593</a></p>
<p>这位女士在GNOME bugzilla上提交bug，bug提交在empathy项目下。（注 dict empathy: 心意相通）</p>
<p>先不看正文，备注信息就极具幽默感：<br />
Status:  	 RESOLVED INVALID<br />
Product: 	empathy<br />
Component: 	User Guide<br />
Version: 	unspecified<br />
OS: 	Windows<br />
Importance:  	Normal critical </p>
<p>是不是真的RESOLVED就不知道了。</p>
<p>事情的直接原因是上周海牙GUADEC，此男cancel了周末和这位reporter的约会。此女不堪长期忍受此男、Linux、Maemo、C等等，彻底爆发了。</p>
<p>He even tried to put Linux on my computer and I simply could not take it.  I came home from work one day and my computer said &#8220;UNIX&#8221; all over it!<br />
这句有力的证明了我曾经看到的一句箴言，给女生装linux，对她们、对电脑、对linux都是一种折磨。</p>
<p>接下来搞笑开始了。一楼就是一位极缺乏幽默感的大叔：<br />
Akhil Laddha      2010-08-11 06:45:46 UTC<br />
This is a GNOME bug tracking system, not any family consultancy.</p>
<p>二楼是位好心人，提出了一个Linux week计划，还一厢情愿整了个交易计划：<br />
for each bug you report, he has to spend one night with you without the computer.</p>
<p>八楼精华：<br />
 David Liang      2010-08-12 08:53:16 UTC<br />
不得不顶</p>
<p>九楼亮出一个家属俱乐部的邮件列表：<br />
gnome-women-list@gnome.org，说你要是在家属圈子里麻将打得无敌手，自然你的boyfriend就崇拜你了，到时你就是爷了</p>
<p>高潮在十楼出现了，“你不说这男的是谁我们怎么帮你？”</p>
<p>紧接着十一楼一位神秘人士笑而不语。</p>
<p>十四楼比较直接<br />
#apt-get remove boyfriend &#8211;purge</p>
<p>十九楼知道宁拆十座庙的道理，建议先查看一下情况再说：<br />
cat /dev/boyfriend | grep love</p>
<p>最冷的是十六楼说咱们有这么个项目的：<br />
<a href="http://projects.gnome.org/outreach/women/">http://projects.gnome.org/outreach/women/</a></p>
<p>你以为故事就这么结束了，你错了。<br />
没想到男主人公的网站被我不经意间人肉出来了：<br />
<a href="http://zachgoldberg.com">http://zachgoldberg.com</a></p>
<p>一上来第一篇就说这事：<br />
<a href="http://zachgoldberg.com/2010/08/12/help-my-girlfriend-learned-how-to-use-a-bug-tracker/">HELP! My Girlfriend Learned How To Use A Bug Tracker</a></p>
<p>I never thought it would happen.</p>
<p>此男字字珠玑：<br />
It all started one night when I got home very late from work (where I get to play with Linux all day… who would ever go home?).  I got the usual “you need to pay more attention to me” and “Linux will never have sex with you!”.  I sat through it all and when it was over she went to sleep and I…. opened up my Laptop (running Ubuntu Linux, of course) and started hacking.  All is right with the world.</p>
<p>于是他发现自己上了LWN的Quote of the Week，和RMS的新闻并列，然后又被转载到hacker news, geek.com, slashdot。他感叹道 I never imagined my entry into the “slashdot number of zero” (think Erdos or Kevin Bacon) club would happen in this way.</p>
<p>最后他说他要开一个bugs.zachgoldberg.com专门解决这类的问题，If you want your own component in the bugtracker to help you and your loved one vent your problems all you need to do is ask!</p>
<p>哈哈哈哈</p>
<p>补充个精华链接：http://www.reddit.com/r/linux/comments/d02j6/bug_626593_gnome_ate_my_boyfriend/</p>
<p>最后daf同学总结性地指出，她不会学习使用bug tracker。</p>
<p>The post is brought to you by <a href="http://fedorahosted.org/lekhonee">lekhonee</a> v0.7</p></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2010/08/11/beanstalkd/">Beanstalkd</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-08-11T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://kr.github.com/beanstalkd/">beanstalkd</a>是一个极轻量级的消息队列服务，作者的说法叫做Work Queue。</p>

<p><h3>概念</h3></p>

<p>Beanstalkd里包含以下几个概念：
<ul>
<li>Producer</li>
<li>Worker</li>
<li>Job</li>
<li>Tube</li>
</ul></p>

<p>Producer 与传统的消息队列服务中的概念类似，是Job的生产者。这个角色通过put命令来创建Job。</p>

<p>Worker 即消费者，worker通过reserve / release / bury / delete 等命令操作job的生命周期。</p>

<p>Job 是beanstalkd中的基本单元，一个job包含id和body，从属于一个tube。Job的生命周期是beanstalkd中的核心概念，它包含DELAYED / READY / RESERVED / BURIED / DELETED等状态。beanstalkd文档中的这个图对Job的声明周期进行了说明：
<a href="http://github.com/kr/beanstalkd/blob/master/doc/protocol.txt#L81">http://github.com/kr/beanstalkd/blob/master/doc/protocol.txt#L81</a></p>

<p>Tube 是类似namespace的概念，Producer在生产Job前通过use指定相应的Tube。而Worker通过watch / Ignore命令来决定从哪些Tube中获得Job。</p>

<p><h3>安装</h3></p>

<p>Beanstalkd 可以通过很多Linux发行版的包管理器直接安装。依赖libevent 1.4.1 以上版本。<br />
通过以下命令启动即可</p>

<p><i>beanstalkd -d -p &lt;PORT&gt;</i></p>

<p><h3>协议</h3>
Beanstalkd在各方面都继承memcached的风格，协议也与memcached类似，同样是基于文本的：</p>

<p>命令 参数 [参数&#8230;] [命令体字节数]\r\n<br />
[命令体]\r\n</p>

<p>beanstalkd很多命令的返回是yaml格式，但是系统对命令体的格式并没有限制。</p>

<p><h3>客户端</h3></p>

<p>Beanstalkd协议见简单，有各种语言的客户端实现。python有一个非常简单的beanstalkc，可以通过easy_install安装。不过，这个客户端缺少断线重连机制，正式发布的0.2.0版本也有一些严重的bug。可以从github上下载源代码安装，并在使用时控制重连。</p>

<p>The post is brought to you by <a href="http://fedorahosted.org/lekhonee">lekhonee</a> v0.7</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2010/08/09/%E8%BF%91%E5%86%B5-2/">近况</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-08-09T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><ol>
<li>Exaile豆瓣电台插件发布一个多月，github和googlecode的下载量加载一起大约有190次左右。考虑的这两个用户群的交集有限，这个数字应该算是超乎期望了，呵呵。等下载量超过500的时候，我。。。</li>
<li>本来计划三周做完的项目，后台服务调用的中间件，做了刚一周整个流程刚跑通就被砍了。最近工作得很不顺心，公司各种产品之间结构松散，模型各不相同，想要all in one谈何容易。不愉快就容易萌生去意，可是看了JavaEye robbin的<a href="http://robbin.javaeye.com/blog/730223">这篇</a>，就彷徨了。</li>
<li>上面一节原本写了不少，但考虑到说出来不太合适，就删了。你懂的。</li>
<li>最近听豆瓣电台非常喜欢苏阳、野孩子这些西北味的歌，我毕竟还是干旱地区的人，听着就有共鸣。苏阳的<a href="http://www.douban.com/artist/suyang/download?song_id=10027">长在银川</a>我很喜欢，我喜欢这种带着地名的歌。有西北的味道，能让我想起小时候。“我的家住在，<a href="http://j.map.baidu.com/8n8f">同心路</a>边上” ，如果有机会，能去考察一下就太他妈好了。</li>
<li>今天图灵把<a href="http://www.turingbook.com/Data/Newswire/d3aaad02-1af3-47df-8e87-d06e0a88672e/Asset/Newsletter_201008.html">八月份的新书</a>列出来，发现这么一本《我编程，我快乐》。本来评价不错的书，起这么个名字，你说谁还敢买，买了还不被同事鄙视死。编辑同志您做到了！</li>
<li>最近某公司的电子书宣传力度很大，连<a href="http://www.cnbeta.com/articles/118806.htm">CEO都请自上阵</a>的（请注意右侧第二条）。我突然想买个Kindle，上周五在Amazon.com上订了到了最后一步，结果是地址不能邮寄。看来还得想其他办法，今天貌似关于国际网购邮寄有了新的<a href="http://finance.ce.cn/rolling/201008/09/t20100809_16064224.shtml">规定</a>。</li>
</ol></p>

<p>The post is brought to you by <a href="http://fedorahosted.org/lekhonee">lekhonee</a> v0.7</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2010/08/03/exaile-doubanfm-plugin-for-exaile-0-3-2/">Exaile-doubanfm-plugin for Exaile 0.3.2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-08-03T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Ubuntu 10.04的Exaile还停留在0.3.1，而Fedora 13上已经升级到0.3.2了。为此我更新了豆瓣电台插件，现在这个版本可以在0.3.2上正常工作。</p>

<p>可以到github的下载页面获取 doubanfm-0.0.3a-exaile032.tar.gz
<a href="http://github.com/sunng87/exaile-doubanfm-plugin/downloads">http://github.com/sunng87/exaile-doubanfm-plugin/downloads</a></p>

<p>此外for exaile 0.3.1的版本也有一个优化和bugfix release, Ubuntu用户可以获取<br />
doubanfm-0.0.3-exaile031.tar.gz</p>

<p>接下来三周又有项目了，难度比较大，估计豆瓣插件近期不会有什么新的惊喜了。</p>

<p>The post is brought to you by <a href="http://fedorahosted.org/lekhonee">lekhonee</a> v0.7</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2010/07/31/sunngs-pastebin/">Sunng&#8217;s Pastebin</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-07-31T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>写了一个基本的pastebin放在appengine上：
<a href="http://sunoffline.appspot.com/pb/">http://sunoffline.appspot.com/pb/</a></p>

<p>支持纯文本、Markdown和代码高亮。数据永久保留，推荐大家收藏以备不时之需。</p>

<p>The post is brought to you by <a href="http://fedorahosted.org/lekhonee">lekhonee</a> v0.7</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2010/07/26/%E7%94%A8markdown%E4%B9%A6%E5%86%99%E6%96%87%E6%A1%A3/">用markdown书写文档</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-07-26T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>写文档是头疼事，没人愿意写文档。在word里写文档，时间长了都怀疑自己是不是搞技术的。我阅历有限，在我的印象里就没有用word格式看过什么有价值的东西。只要一打开word想到的就是连篇累牍的废话、码字。word最重要的功能是什么？保存。其次呢？字数统计。我所写过的word文档绝大多数都是“只写”的，通常作为流程里的一个附件，没有人真正去看。</p>

<p>以上是人身攻击，接下来比较实际的问题，word文档不是符合unix哲学的东西。格式不开放，你就没有办法进行diff操作，把word文档放到svn里，只能使用最基本的版本控制，没法查看changeset，只知道改了，不知道改了什么。</p>

<p>为了改变这种情况，我试过用<a href="http://www.docbook.org/">docbook</a>格式。docbook用xml书写，定义了一套复杂的Schema，详细到作者的email都有定义。docbook还有丰富的工具集，可以通过xsl把docbook转换成所有你知道的文档格式。<a href="http://www.sonatype.com/products/maven/documentation/book-defguide">Maven: the Definitive Guide</a>就是用docbook写成的。不过用docbook也存在一些问题，docbook太复杂了，用纯文本编辑器很难处理，作者的学习曲线也比较高，需要所见即所得的编辑器支持。与docbook相类似的DITA，也存在这样的问题，它们是重量级的格式。</p>

<p>轻量级的Wiki格式不错，但是Wiki格式很让人头疼就是没有统一的规范。举例，dokuwiki里顶级标题是6个=，而moinmoin里顶级标题恰恰相反是一个=，不portable，文档维护起来就非常麻烦。</p>

<p>铺垫了这么多，委屈以上格式了，该<a href="http://daringfireball.net/projects/markdown/">markdown</a>出场了。markdown是简单的html原型，用来生成html，它的设计目标就是为了KISS，兼容html。看看一些必要的格式吧：（或者直接看<a href="http://en.wikipedia.org/wiki/Markdown">Wikipedia</a>）<br />
标题<br />
# 标题<br />
## 二级标题<br />
&#8230;<br />
###### 六级标题</p>

<p>对于一级标题还可以这么写<br />
headline<br />
========<br />
二级标题可以<br />
headline<br />
&#8212;&#8212;&#8211;<br />
这个怎么输入呢，我想起来前几天看vim hacks里的一组快捷键<br />
yypoVr=<br />
yypoVr-<br />
谁用谁知道</p>

<p>段落：<br />
一段文本以两个换行结束。<br />
换行：<br />
一行文本行末两个空格。</p>

<p>图片<br />
![alternative text](image-url &#8220;image-title&#8221;)<br />
用markdown，图片的alt你不写都不行。</p>

<p>链接<br />
[Linktext](link &#8220;linktitle&#8221;)</p>

<p>列表<br />
ul 无序列表<br />
*
*<br />
ol 有序列表<br />
1.<br />
2.</p>

<p>以上就是主要的格式支持。用标题来划分文档层次，没有多余的格式，没有机会让你五颜六色。</p>

<p>在linux上可以安装markdown的处理脚本：<br />
apt-get install markdown<br />
安装vim的语法文件：<br />
http://www.vim.org/scripts/script.php?script_id=1242<br />
这里是一个简单的例子：<br />
http://github.com/sunng87/exaile-doubanfm-plugin/blob/master/README.mkd</p>

<p>The post is brought to you by <a href="http://fedorahosted.org/lekhonee">lekhonee</a> v0.7</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2010/07/21/bottle-fapws3/">Bottle & Fapws3</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-07-21T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://github.com/defnull/bottle">Bottle</a>是一个Python web框架，兼容<a href="http://www.python.org/dev/peps/pep-0333">wsgi</a>标准，lightweight，self-contained。</p>

<p>提到web框架，自然要和相类似的python框架相比。</p>

<p>Django是大型框架，包含ORM、Controller、Templating全套，这也是Django的缺点，使用Django意味着必须使用关系型数据库进行存储（尽管有一些Model层的其他实现，但绝大多数都是Hack的方式实现），必须使用Django并不非常出色的Template系统。Pylons针对Django的这些问题，采用了松散的方式，数据层可选择由SQLAlchemy实现，模板系统可以选择mako / jinja等。Pylons用paster来管理项目、创建代码模板。借鉴了rails的哲学，目录结构也相类似。可是pylons仍然显得重量级，把注意力放到web.py。只要定义一个router，定义相应的handler就可以处理web请求，handler对象的GET POST等方法分别对应相应的HTTP请求。看起来不错了，不过与bottle相比，webpy仍然显得繁琐、功能有限，而且它本身的db模块就更加鸡肋了。</p>

<p>看一个实例便知：<br />
定义一个简单的HTTP页面：<br />
[cc lang=&#8221;python&#8221;]<br />
from bottle import Bottle, run, mako_view, request<br />
from bottle import FapwsServer</p>

<p>myapp = Bottle()</p>

<p>@myapp.route(&#8216;/nihao/:name/:count#&#92;d+#&#8217;)<br />
@mako_view(&#8216;nihao&#8217;)<br />
def nihao(name, count):<br />
    return dict(n=name, c=int(count), ip=request.environ.get(&#8216;REMOTE_ADDR&#8217;))</p>

<p>run(app=myapp, server=FapwsServer)</p>

<p>[/cc]<br />
对应的nihao.tpl模板，用mako引擎实现：<br />
[cc lang=&#8221;html&#8221;]
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" /></head></html></p>

<p>    <title>Nihao</title></p>

<p>
<body>
    <div id="ip">
        <h1 id="heading">Request From ${ip}</h1>
    </div>
    <%def name="greeting(n)">
        <div id="name">
            Nihao ${n}<br />
        </div>
    </%def>
    % for i in range(c):<br />
        ${greeting(n)}<br />
    % endfor
</body>

[/cc]<br />
仅仅是一些简单的内容，接着只需要：
<i>python bottle-test.py</i>
即可运行服务器。</p>

<p>bottle通过decorator定义route规则，还支持url提取参数。通过decorator指定模板、模板引擎。可以说近乎简化到了极致。</p>

<p>bottle遵循单一职责原则，不提供数据层的实现，由用户自己指定，bottle没有任何限制。模板引擎，bottle支持mako / jinja / cheetah，本身还内建一个默认SimpleTemplate引擎。bottle还支持多种wsgi服务器，包括flup / wsgiref / cherrypy / paste / twisted / tornado / fapws3 等等。</p>

<p>最后提一个wsgi的实现<a href="http://github.com/william-os4y/fapws3">fapws3</a>，号称是目前最快的wsgi服务器。fapws3用libev实现，在不同的操作系统上采用不同的多路IO模型以达到高性能。</p>

<p>bottle的作者做过一个关于不同实现的性能比较：
<a href="http://bottle.paws.de/page/2009-12-19_Comparing_HelloWorld_Performance">http://bottle.paws.de/page/2009-12-19_Comparing_HelloWorld_Performance</a></p>

<p>The post is brought to you by <a href="http://fedorahosted.org/lekhonee">lekhonee</a> v0.7</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2010/07/17/bayeux-protocol/">Bayeux Protocol</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-07-17T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>运行一个CometD Demo非常简单，只要创建一个Maven项目即可（<a href="http://cometd.org/documentation/howtos/primer">CometD Howtos</a>）：
<i>$ mvn archetype:generate -DarchetypeCatalog=http://cometd.org</i></p>

<p>maven会提示用户选择archetype，包括cometd的版本1、版本2，jetty6、jetty7的实现，以及客户端dojo或jquery的实现。这里可以选择最新的：
<i>http://cometd.org -> cometd-archetype-dojo-jetty7 (2.0.0 - CometD archetype for creating a server-side event-driven web application)</i></p>

<p>项目创建完成后执行mvn jetty:run即可，打开http://127.0.0.1:8080/{artifactId}即可。</p>

<p>CometD的协议包容了各种主要的浏览器，比如在Chromium 5上，dojo采用WebSocket实现；而在不支持WebSocket的Firefox 3上，通过long-polling实现。Bayuex是一个应用协议，CometD是Bayuex的实现，类似鸡与蛋的关系。</p>

<p>有了昨天在Chromium上看WebSocket协议的经验，先看一下CometD的WebSocket实现：<br />
握手。客户端请求/{artifactId}/cometd/handshake<br />
包含Header
<blockquote>GET /cometd-jetty/cometd/handshake HTTP/1.1<br />
Upgrade: WebSocket<br />
Connection: Upgrade<br />
Host: 127.0.0.1:8080<br />
Origin: http://127.0.0.1:8080<br />
Cookie: JSESSIONID=12jqq6hbsfkfic8vzqpevxtrw
</blockquote></p>

<p>这是标准的WebSocket握手协议，服务端返回：</p>

<p><blockquote>HTTP/1.1 101 Web Socket Protocol Handshake<br />
Upgrade: WebSocket<br />
Connection: Upgrade<br />
WebSocket-Origin: http://127.0.0.1:8080<br />
WebSocket-Location: ws://127.0.0.1:8080/cometd-jetty/cometd/handshake</blockquote></p>

<p>双方完成WebSocket连接的建立。客户端通过websocket发送JSON，进行bayuex的握手：</p>

<p><blockquote>[{&#8220;version&#8221;:&#8221;1.0&#8221;,&#8221;minimumVersion&#8221;:&#8221;0.9&#8221;,&#8221;channel&#8221;:&#8221;/meta/handshake&#8221;,&#8221;supportedConnectionTypes&#8221;:[&#8220;websocket&#8221;,&#8221;long-polling&#8221;,&#8221;callback-polling&#8221;],&#8221;advice&#8221;:{&#8220;timeout&#8221;:60000,&#8221;interval&#8221;:0},&#8221;id&#8221;:&#8221;1&#8221;}]</blockquote></p>

<p>服务端返回JSON，下发clientId完成握手：</p>

<p><blockquote>[{&#8220;channel&#8221;:&#8221;/meta/handshake&#8221;,&#8221;clientId&#8221;:&#8221;8g6dbnlqr2k6jfo1tdpaeb7iw&#8221;,&#8221;version&#8221;:&#8221;1.0&#8221;,&#8221;successful&#8221;:true,&#8221;minimumVersion&#8221;:&#8221;1.0&#8221;,&#8221;id&#8221;:&#8221;1&#8221;,&#8221;supportedConnectionTypes&#8221;:[&#8220;websocket&#8221;,&#8221;long-polling&#8221;,&#8221;callback-polling&#8221;]}]</blockquote></p>

<p>握手完成，bayuex连接建立。</p>

<p>在Demo中，客户端添加了一个handshake的listerner<br />
[cc lang=&#8221;javascript&#8221;]<br />
    function _metaHandshake(handshake)<br />
    {<br />
        if (handshake.successful === true)<br />
        {<br />
            cometd.batch(function()<br />
            {<br />
                cometd.subscribe(&#8216;/hello&#8217;, function(message)<br />
                {<br />
                    dojo.byId(&#8216;body&#8217;).innerHTML += &#8217;<div>Server Says: &#8217; + message.data.greeting + &#8217;</div>&#8217;;<br />
                });<br />
                // Publish on a service channel since the message is for the server only<br />
                cometd.publish(&#8216;/service/hello&#8217;, { name: &#8216;World&#8217; });<br />
            });<br />
        }<br />
    }<br />
[/cc]<br />
所以在完成握手后，客户端发送一个批量请求，subscribe /hello频道，并且向/service/hello发送json格式的消息。向/service channel发送的信息<a href="http://svn.cometd.com/trunk/bayeux/bayeux.html#toc_81">表示客户端与服务端的单独通信</a>，不会被转发给其他客户端。<br />
id用于区分每个请求，<a href="http://svn.cometd.com/trunk/bayeux/bayeux.html#toc_38">bayuex spec规定</a>向/meta和/service发送的请求必须包含id字段，用于标示请求响应。<br />
请求的内容最终聚合为一个Json</p>

<p><blockquote>[{&#8220;channel&#8221;:&#8221;/meta/subscribe&#8221;,&#8221;subscription&#8221;:&#8221;/hello&#8221;,&#8221;id&#8221;:&#8221;2&#8221;,&#8221;clientId&#8221;:&#8221;8g6dbnlqr2k6jfo1tdpaeb7iw&#8221;},{&#8220;channel&#8221;:&#8221;/service/hello&#8221;,&#8221;data&#8221;:{&#8220;name&#8221;:&#8221;World&#8221;},&#8221;id&#8221;:&#8221;3&#8221;,&#8221;clientId&#8221;:&#8221;8g6dbnlqr2k6jfo1tdpaeb7iw&#8221;}]</blockquote></p>

<p>服务端发回响应，id=2的请求成功，订阅/hello频道成功</p>

<p><blockquote>[{&#8220;channel&#8221;:&#8221;/meta/subscribe&#8221;,&#8221;successful&#8221;:true,&#8221;id&#8221;:&#8221;2&#8221;,&#8221;subscription&#8221;:&#8221;/hello&#8221;}]</blockquote></p>

<p>之后，服务端发回/hello channel的消息</p>

<p><blockquote>[{&#8220;channel&#8221;:&#8221;/hello&#8221;,&#8221;data&#8221;:{&#8220;greeting&#8221;:&#8221;Hello, World&#8221;}},{&#8220;channel&#8221;:&#8221;/service/hello&#8221;,&#8221;successful&#8221;:true,&#8221;id&#8221;:&#8221;3&#8221;}]</blockquote></p>

<p>客户端还要定期发送连接请求保持连接</p>

<p><blockquote>[{&#8220;channel&#8221;:&#8221;/meta/connect&#8221;,&#8221;connectionType&#8221;:&#8221;websocket&#8221;,&#8221;advice&#8221;:{&#8220;timeout&#8221;:0},&#8221;id&#8221;:&#8221;4&#8221;,&#8221;clientId&#8221;:&#8221;8g6dbnlqr2k6jfo1tdpaeb7iw&#8221;}]</blockquote></p>

<p>服务端返回，连接成功</p>

<p><blockquote>[{&#8220;channel&#8221;:&#8221;/meta/connect&#8221;,&#8221;advice&#8221;:{&#8220;reconnect&#8221;:&#8221;retry&#8221;,&#8221;interval&#8221;:2500,&#8221;timeout&#8221;:15000},&#8221;successful&#8221;:true,&#8221;id&#8221;:&#8221;4&#8221;}]</blockquote></p>

<p>connect请求是用于在客户端和服务端维持连接， Bayeux标准中提到(<a href="http://svn.cometd.com/trunk/bayeux/bayeux.html#toc_52">1</a>, <a href="http://svn.cometd.com/trunk/bayeux/bayeux.html#toc_53">2</a>)：</p>

<p><blockquote>A transport MUST maintain one and only one outstanding connect message. When a HTTP response that contains a /meta/connect response terminates, the client MUST wait at least the interval specified in the last received advice before following the advice to reestablish the connection </blockquote></p>

<p><blockquote>
The client MUST maintain only a single outstanding connect message. If the server does not have a current outstanding connect and a connect is not received within a configured timeout, then the server SHOULD act as if a disconnect message has been received. </blockquote></p>

<p>至此，cometd客户端就可以在/hello频道上订阅、发布消息了。<br />
在Chromium上，所有的操作都在一个WebSocket连接上完成。</p>

<p>而当断开连接时，客户端向服务端发送</p>

<p><blockquote>[{&#8220;channel&#8221;:&#8221;/meta/disconnect&#8221;,&#8221;id&#8221;:&#8221;188&#8221;,&#8221;clientId&#8221;:&#8221;a8iutjvfp7dtwhzrfujeonk5q&#8221;}]</blockquote></p>

<p>服务端响应</p>

<p><blockquote>[{&#8220;channel&#8221;:&#8221;/meta/disconnect&#8221;,&#8221;successful&#8221;:true,&#8221;id&#8221;:&#8221;188&#8221;}]</blockquote></p>

<p>Bayuex基本上就可以理解为一个websocket上的应用协议了。</p>

<p>再看看Firefox 3.6上的实现。Firefox 3.6不支持WebSocket，所有的通信只能通过XHR来实现。<br />
握手，通过一个xhr post请求实现：</p>

<p><blockquote>POST /{artifactId}/cometd/handshake HTTP/1.1<br />
Host: 127.0.0.1:8080<br />
User-Agent: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.2.6) Gecko/20100628 Ubuntu/10.04 (lucid) Firefox/3.6.6<br />
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8<br />
Accept-Language: en-us,en;q=0.5<br />
Accept-Encoding: gzip,deflate<br />
Accept-Charset: UTF-8,*<br />
Keep-Alive: 115<br />
Connection: keep-alive<br />
Content-Type: application/json;charset=UTF-8<br />
X-Requested-With: XMLHttpRequest<br />
Referer: http://127.0.0.1:8080/{artifactId}/<br />
Content-Length: 182<br />
Cookie: JSESSIONID=fjnyxb28raih1cnaljrijl1ic<br />
Pragma: no-cache<br />
Cache-Control: no-cache
</blockquote></p>

<p>服务器端响应：</p>

<p><blockquote>HTTP/1.1 200 OK<br />
Content-Type: application/json;charset=UTF-8<br />
Set-Cookie: BAYEUX_BROWSER=df92-h8q89f416mutgbpxrwb8185u;Path=/<br />
Content-Length: 213<br />
Server: Jetty(7.1.5.v20100705)</blockquote></p>

<p>[{&#8220;channel&#8221;:&#8221;/meta/handshake&#8221;,&#8221;clientId&#8221;:&#8221;9185k23lo482oq1po3ivxup2cj&#8221;,&#8221;version&#8221;:&#8221;1.0&#8221;,&#8221;successful&#8221;:true,&#8221;minimumVersion&#8221;:&#8221;1.0&#8221;,&#8221;id&#8221;:&#8221;1&#8221;,&#8221;supportedConnectionTypes&#8221;:[&#8220;websocket&#8221;,&#8221;long-polling&#8221;,&#8221;callback-polling&#8221;]}]</p>

<p>握手完成，执行客户端定义的回调。发送bayeux请求，通过一个新的XHR上<br />
[{&#8220;channel&#8221;:&#8221;/meta/subscribe&#8221;,&#8221;subscription&#8221;:&#8221;/hello&#8221;,&#8221;id&#8221;:&#8221;2&#8221;,&#8221;clientId&#8221;:&#8221;9185k23lo482oq1po3ivxup2cj&#8221;},{&#8220;channel&#8221;:&#8221;/service/hello&#8221;,&#8221;data&#8221;:{&#8220;name&#8221;:&#8221;World&#8221;},&#8221;id&#8221;:&#8221;3&#8221;,&#8221;clientId&#8221;:&#8221;9185k23lo482oq1po3ivxup2cj&#8221;}]</p>

<p>服务端同时返回三个bayuex的请求响应</p>

<p><blockquote>[{&#8220;channel&#8221;:&#8221;/meta/subscribe&#8221;,&#8221;successful&#8221;:true,&#8221;id&#8221;:&#8221;2&#8221;,&#8221;subscription&#8221;:&#8221;/hello&#8221;},{&#8220;channel&#8221;:&#8221;/hello&#8221;,&#8221;data&#8221;:{&#8220;greeting&#8221;:&#8221;Hello, World&#8221;}},{&#8220;channel&#8221;:&#8221;/service/hello&#8221;,&#8221;successful&#8221;:true,&#8221;id&#8221;:&#8221;3&#8221;}]</blockquote></p>

<p>客户端开始发送连接请求</p>

<p><blockquote>[{&#8220;channel&#8221;:&#8221;/meta/connect&#8221;,&#8221;connectionType&#8221;:&#8221;long-polling&#8221;,&#8221;advice&#8221;:{&#8220;timeout&#8221;:0},&#8221;id&#8221;:&#8221;4&#8221;,&#8221;clientId&#8221;:&#8221;9185k23lo482oq1po3ivxup2cj&#8221;}]</blockquote></p>

<p>注意这里使用的是<a href="http://svn.cometd.com/trunk/bayeux/bayeux.html#toc_69">long-polling</a>方式，这是由dojo针对浏览器特性决定的。</p>

<p><blockquote>Long-polling server implementations attempt to hold open each request until there are events to deliver; the goal is to always have a pending request available to use for delivering events as they occur, thereby minimizing the latency in message delivery.</blockquote></p>

<p>如果没有新消息，服务端阻塞十秒后返回</p>

<p><blockquote>[{&#8220;channel&#8221;:&#8221;/meta/connect&#8221;,&#8221;successful&#8221;:true,&#8221;id&#8221;:&#8221;7&#8221;}]</blockquote></p>

<p>客户端接收到返回立刻发起新的connect请求</p>

<p>当有新消息时，阻塞在服务器端的connect请求会立即返回，同时带回新的消息，如
<blockquote>[{&#8220;channel&#8221;:&#8221;/hello&#8221;,&#8221;data&#8221;:{&#8220;name&#8221;:&#8221;555&#8221;},&#8221;id&#8221;:&#8221;6&#8221;},{&#8220;channel&#8221;:&#8221;/meta/connect&#8221;,&#8221;successful&#8221;:true,&#8221;id&#8221;:&#8221;619&#8221;}]</blockquote>
而如果是本客户端publish的新消息，会在请求成功的响应中返回，不会影响connect连接，如：
<blockquote>[{&#8220;channel&#8221;:&#8221;/hello&#8221;,&#8221;data&#8221;:{&#8220;name&#8221;:&#8221;nihao&#8221;},&#8221;id&#8221;:&#8221;715&#8221;},{&#8220;channel&#8221;:&#8221;/hello&#8221;,&#8221;successful&#8221;:true,&#8221;id&#8221;:&#8221;715&#8221;}]</blockquote></p>

<p>断开时，仍然是通过xhr post一条bayuex命令到服务端
<blockquote>[{&#8220;channel&#8221;:&#8221;/meta/disconnect&#8221;,&#8221;id&#8221;:&#8221;750&#8221;,&#8221;clientId&#8221;:&#8221;9185k23lo482oq1po3ivxup2cj&#8221;}]</blockquote>
服务端响应：
<blockquote>[{&#8220;channel&#8221;:&#8221;/meta/disconnect&#8221;,&#8221;successful&#8221;:true,&#8221;id&#8221;:&#8221;750&#8221;}]</blockquote></p>

<p>至此，通过long polling方式实现bayuex的cometd客户端也描述清楚了。long-polling仍然是通过connect请求来实现pull的方式准实时，与websocket真正push的方式还是存在区别的。</p>

<p>The post is brought to you by <a href="http://fedorahosted.org/lekhonee">lekhonee</a> v0.7</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/blog/page/22/">&larr; Older</a>
    
    <a href="/blog/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/blog/page/20/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/blog/2014/04/20/rust-concurrent-made-safely/">Rust语言：安全的并发</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2014/03/04/slacker-0-dot-11-released/">Slacker Library Updated</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/10/22/swapping-harddisk-without-pain/">Archlinux 安全更换硬盘</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/10/08/delicious-released/">Delicious 发布</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/07/16/four-years-as-programmer/">工作四周年</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/sunng87">@sunng87</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'sunng87',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/blog/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>On Delicious</h1>
  <div id="delicious"></div>
  <script type="text/javascript" src="http://feeds.delicious.com/v2/json/classicing?count=3&amp;sort=date&amp;callback=renderDeliciousLinks"></script>
  <p><a href="http://delicious.com/classicing">My Delicious Bookmarks &raquo;</a></p>
</section>




  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Sun Ning -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'sunng-blog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
