
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>车水马龙</title>
  <meta name="author" content="Sun Ning">

  
  <meta name="description" content="Stages原先是业余时间开发的一个简单的框架，用来实现SEDA。不过现在这个库经过同事们的加强，已经用在了美味和zeen的生产环境。最近我也对开源的这个分支做了一些修改。 首先是使用更安全的线程池，现在必须指定任务积压后的策略，即RejectionHandler。用户也可以设置自己的Queue， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://sunng87.github.io/blog//blog/page/3">
  <link href="/blog/favicon.png" rel="icon">
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="车水马龙" type="application/atom+xml">
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/blog/">车水马龙</a></h1>
  
    <h2>here comes the sun</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:sunng87.github.io/blog/" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/blog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2012/07/13/%E6%9B%B4%E6%96%B0%E4%BA%86stages/">更新了stages</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-13T00:00:00+08:00" pubdate data-updated="true">Jul 13<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://github.com/sunng87/stages">Stages</a>原先是业余时间开发的一个简单的框架，用来实现SEDA。不过现在这个库经过同事们的加强，已经用在了美味和zeen的生产环境。最近我也对开源的这个分支做了一些修改。</p>

<p>首先是使用更安全的线程池，现在必须指定任务积压后的策略，即RejectionHandler。用户也可以设置自己的Queue，并且指定允许的大小。这是之前应该要做但是一直没做的事情。</p>

<p>其次在Task上增加了一个priority属性，如果你使用的是PriorityBlockingQueue，那么任务会根据这个优先级排序。但是由于PriorityBlockingQueue是unbounded，所以请慎用这个功能。</p>

<p>另外，现在所有的Task都通过perf4j计时，你可以用过配置log4j打印出性能报表日志。也可以通过JMX将耗时情况发布出去，我们在生产环境里通过ganglia监控了这些数据，还是比较有参考价值的。</p>

<p>最后，现在jmx监控stage积压队列的功能终于实现了。我会把每个队列的pending tasks数量通过mbean暴露出来，同样可以配置监控这个数据。有了这个数据后，我们可以很明确地了解各个stage的压力情况，调整线程池的策略。</p>

<p><img src="http://i.imgur.com/ashLh.png" alt="" /></p>

<p></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2012/07/02/timing-brings-perf4j-to-clojure/">Timing Brings Perf4j to Clojure</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-02T00:00:00+08:00" pubdate data-updated="true">Jul 2<span>nd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://github.com/sunng87/timing" target="_blank">Timing</a> is a dead simple clojure library wraps perf4j, while perf4j is an advanced library to log call time. It&#8217;s like log4j to System.out.println, that to System.currentTimeMillies. </p>

<p>The core part of Timing library is a `timed` macro. You can put any forms in it and it will log the call time.</p>

<p>[cc lang=&#8221;clojure&#8221;]<br />
(timed &#8220;demo&#8221;<br />
  (look-for-something-from-the-moon)<br />
  &#8230;)<br />
[/cc]</p>

<p>And it logs:<br />
start[1341215254682] time[1000] tag[demo]</p>

<p>Timing looks up your classpath at startup for a logging backend: slf4j or log4j. If neither of them found, it fails back to log to stderr. By the way, log4j is the recommended logging backend. There are some predefined appender in perf4j to generate semi-realtime summary and charts. Anyway, Timing, as a library, doesn&#8217;t depend on any library other than perf4j.</p>

<p>The project is hosted at <a href="https://github.com/sunng87/timing" target="_blank">github</a> and available on clojars of version &#8220;0.1.0&#8221;.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2012/06/17/%E7%99%BBpy%E5%B1%B1/">登Py山</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-17T00:00:00+08:00" pubdate data-updated="true">Jun 17<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>我的个天总算是有可写的东西了。</p>

<p>这次来北京有个重要的主题叫做锻炼身体，为此不惜代价抓住有效的机会来参加这些活动。昨天跑去爬了昌平十三陵水库旁边的蟒山。这个蟒山的，我就叫他python山。据说是本地爬山的入门路线之一。这次活动正好副领队又是三年多没见过的老同学，于是就毫不犹豫地参加了。爬山前的周四是上线的日子，晚上折腾到两点多，第二天又早早去上班。我要说的是周六显然不在最佳状态。</p>

<p>上次有这样的活动还是07年去庐山，那次就几乎中暑倒在山谷里了，为了避免悲剧发生这次背了3升水上山。这山是前半段比较陡，后半段稍微好一些。还是和上次庐山一样，跟着体力好走得快的人，很快就把力气用完了，坐在路边上一歇就是十五分钟，眼看着从队伍前头落到了队尾。然后也没有然后了，登顶的时候确实是在队尾。一开始还有心思照照相，后来赶紧把相机收起来，你不知道那个相机在肚子上一弹一弹的多耗费体力。</p>

<p>登顶之后吃过午饭感觉就好多了，下到天池看了一样大水库，然后再从景区的台阶返回。据说下山的路是1299级台阶。还是一样，刚出发的时候还在前面，走着走着就看见收队的同学了。下台阶下得两腿发颤，最累的时候感觉随时都可能腿一软就坐下了，幸好这种情况没有发生。</p>

<p>这次爬山最有成就感的，除了没有掉队以外，就是没出什么洋相。比庐山下山时坐倒n次要强多了。另外就是参加这个活动，可以跟各个年龄层次的人一起，也是感受一下这些有活力有生活的人。平时接触的年轻人、网民什么的太多了，总是无时不刻地抱怨却少有行动，够腻歪。跟大家一起爬山，是有一种完全不同的空气。</p>

<p>最后就是风景真好，不虚此行。遗憾是只带了35/1.8的镜头，拍风景有点力不从心。这样壮阔的场面还是应该用18段来拍更精彩。
<a href="http://www.flickr.com/photos/40741608@N08/7384408990/" title="DSC_0014 by 贝小塔, on Flickr"><img src="http://farm6.staticflickr.com/5452/7384408990_31ca11fb21.jpg" width="500" height="336" alt="DSC_0014" /></a></p>

<p><a href="http://www.flickr.com/photos/40741608@N08/7384410222/" title="DSC_0018 by 贝小塔, on Flickr"><img src="http://farm9.staticflickr.com/8019/7384410222_d5e0cd81cc.jpg" width="500" height="336" alt="DSC_0018" /></a></p>

<p><a href="http://www.flickr.com/photos/40741608@N08/7384411678/" title="DSC_0040 by 贝小塔, on Flickr"><img src="http://farm6.staticflickr.com/5114/7384411678_d14f81bab4.jpg" width="500" height="336" alt="DSC_0040" /></a></p>

<p><a href="http://www.flickr.com/photos/40741608@N08/7384413274/" title="DSC_0042 by 贝小塔, on Flickr"><img src="http://farm8.staticflickr.com/7220/7384413274_b65eec8ab8.jpg" width="336" height="500" alt="DSC_0042" /></a></p>

<p><a href="http://www.flickr.com/photos/40741608@N08/7384414130/" title="DSC_0046 by 贝小塔, on Flickr"><img src="http://farm8.staticflickr.com/7100/7384414130_44a25f2442.jpg" width="500" height="336" alt="DSC_0046" /></a></p>

<p><a href="http://www.flickr.com/photos/40741608@N08/7384415136/" title="DSC_0059 by 贝小塔, on Flickr"><img src="http://farm8.staticflickr.com/7233/7384415136_ec1532ce2d.jpg" width="500" height="336" alt="DSC_0059" /></a></p>

<p><a href="http://www.flickr.com/photos/40741608@N08/7384416602/" title="DSC_0069 by 贝小塔, on Flickr"><img src="http://farm8.staticflickr.com/7214/7384416602_f40226b59c.jpg" width="500" height="336" alt="DSC_0069" /></a></p>

<p><a href="http://www.flickr.com/photos/40741608@N08/7384417628/" title="DSC_0071 by 贝小塔, on Flickr"><img src="http://farm8.staticflickr.com/7227/7384417628_0f5f81982c.jpg" width="500" height="336" alt="DSC_0071" /></a></p>

<p><a href="http://www.flickr.com/photos/40741608@N08/7384419526/" title="DSC_0076 by 贝小塔, on Flickr"><img src="http://farm8.staticflickr.com/7097/7384419526_b725db3e50.jpg" width="336" height="500" alt="DSC_0076" /></a></p>

<p><a href="http://www.flickr.com/photos/40741608@N08/7384421628/" title="DSC_0078 by 贝小塔, on Flickr"><img src="http://farm6.staticflickr.com/5321/7384421628_62d1735dcc.jpg" width="500" height="336" alt="DSC_0078" /></a></p>

<p><a href="http://www.flickr.com/photos/40741608@N08/7384422998/" title="DSC_0084 by 贝小塔, on Flickr"><img src="http://farm6.staticflickr.com/5159/7384422998_176421ec81.jpg" width="500" height="336" alt="DSC_0084" /></a></p>

<p><a href="http://www.flickr.com/photos/40741608@N08/7384424660/" title="DSC_0086 by 贝小塔, on Flickr"><img src="http://farm6.staticflickr.com/5464/7384424660_2e5601fc4c.jpg" width="500" height="336" alt="DSC_0086" /></a></p>

<p>以后只要有时间我还去，哪怕还是38度。
</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2012/06/02/keep-alive/">Keep-Alive</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-02T00:00:00+08:00" pubdate data-updated="true">Jun 2<span>nd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>史无前例，上个月只写了一篇blog，再加上网站遭遇认证很多地方都访问不了，故而有必要keep alive一下，该reconnect的请自觉重连。</p>

<p>从家里出来，再次跑到北京来，就做好了艰苦卓绝的思想准备。现在的工作节奏，和2010年春天在盛大在线的时候差不多。那时一腔热血，也没什么经验，做什么事都心里没底。当然也是那段时间学到的东西最多，人生就是这样，熬过一个最困难的时候，总会有巨大的收获（如果没有收获说明还没熬过去，下同）。时过境迁，现在的情况有了巨大的不同，比如看<a href="http://tech.sina.com.cn/i/2012-05-26/03317171784.shtml" target="_blank">这里</a>。曾经没日没夜的奋斗的项目，最后烟消云散仿佛都不存在过。</p>

<p>人最大的瓶颈是时间，时间不可逆，挥霍掉就没有了。为了能有口饭吃，大部分时间还得拿自己的时间去换别人的金钱。如果这个时间能有合理的回报或是各取所需最好，如果这个工作自己也认同倒也不错。如果是纯粹的时间换金钱（所谓工作毕竟是工作），那就难免悲伤了。所以看到<a href="http://www.gsb.stanford.edu/news/research/aaker_happiness_2011.html" target="_blank">这样</a>一篇文章，还是觉得你很有必要快速浏览一下：
<ul>
	<li>Spend time with the right people. </li>
	<li>Spend time on the right activities. </li>
	<li>Enjoy experiences without spending time actually doing them. </li>
	<li>Expand your time. </li>
	<li>Be aware that happiness changes over time.</li>
</ul>
时间自由是人生最高自由。为了合理的利用时间，请关掉你正在折腾配置文件的emacs。</p>

<p>做了一个brogrammer的<a href="http://www.aqee.net/docs/Quiz-Are-You-a-Brogrammer/" target="_blank">测验</a>，和公司同事一起做的。结果得分-105，算是标准nerd了，在公司也是仅次于老板的-120。这个分数基本让人满意，对于那些戴墨镜编程的brogrammer，我想说的是，我的emacs一直是深色背景。</p>

<p></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2012/05/11/%E5%8A%A0%E5%85%A5%E4%BA%86%E7%BE%8E%E5%91%B3%E4%B9%A6%E7%AD%BE/">加入了美味书签</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-11T00:00:00+08:00" pubdate data-updated="true">May 11<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>距离上次更新已经有大半个月的时间了，最近一直忙着搬家和适应新环境。现在我又跑到北京来工作，好在这次终于不是在上地。我记得在写工作第三年的愿望的时候，有一条就是能加入一个优秀的小团队。那么目前看来一切顺利，美味书签这样的团队就是我一直希望能找到的。</p>

<p>我们的团队是Youtube创始人陈士骏的<a href="http://avos.com" target="_blank">AVOS公司</a>中国分支，中国团队由江宏带领，目前有20人，包括技术（前端、后端、移动），编辑等等。我们的团队网站上一一介绍了每个成员，我就不重复了。</p>

<p>在工作上，眼下最好的事情，是我终于可以利用自己喜爱和擅长的技术，来主导一些系统的开发。我们会尽可能地用热爱的语言（毫无疑问是clojure）开发，这想起来就让人兴奋。我这个人对技术还是有一些洁癖和偏执的。这样虽然路漫漫坑无数，但是收获一定不小，过程也在把握中，青春岁月不可再蹉跎了。</p>

<p>最后欢迎大家都来用<a href="http://mei.fm" target="_blank">我们的产品</a>。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2012/04/22/slacker-0-8-0/">Slacker 0.8.0</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-22T00:00:00+08:00" pubdate data-updated="true">Apr 22<span>nd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A new release 0.8.0 of <a href="https://github.com/sunng87/slacker">slacker</a> has been pushed to clojars. Let&#8217;s go through the changes in this version.</p>

<p><h3>Clojure 1.3 compatible</h3>
Slacker finally landed on clojure 1.3. It takes advantages of performance in 1.3. Also, you can use 1.3 API in slacker. For example, a timeout argument is supported in deref, which is useful when dealing with promise returned by slacker&#8217;s asynchronous call.</p>

<p><h3>Performance Boost</h3></p>

<p>The performance enhancement is on the highest priority in this release.  I have migrated the NIO infrastructure to a new library called <a href="https://github.com/sunng87/link">link</a>. Now slacker 0.8.0 is at least <strong>8x</strong> faster than previous release. There is significant improvement both on per-request latency and overall throughput. And the server thread model is optimized for data-intensive tasks. Heavy IO tasks in hosted functions won&#8217;t block the whole server. </p>

<p><h3>slacker as a ring app</h3></p>

<p>Instead of running default transportation, slacker now can be configured as a ring app and deployed on any ring adapter. </p>

<p>[cc lang=&#8221;clojure&#8221;]<br />
(use &#8216;slacker.server)<br />
(use &#8216;ring.adapter.jetty)</p>

<p>(run-jetty (slacker-ring-app (the-ns &#8216;slacker.example.api)) {:port 8080})<br />
[/cc]</p>

<p>This will expose the name space <em>slacker.example.api</em> with HTTP. Functions could be called with following URL pattern:</p>

<p>http://localhost:8080/&lt;namespace&gt;/&lt;function&gt;.&lt;content-type&gt;</p>

<p>For instance: http://localhost:8080/slacker.example.api/timestamp.json</p>

<p><h3>defn-remote</h3></p>

<p>There is a minor update for the defn-remote macro. </p>

<p>In 0.7.0, you have to specify remote namespace with an option:<br />
[cc lang=&#8221;clojure&#8221;]<br />
(defn-remote sc timestamp :remote-ns &#8220;slacker.example.api&#8221;)<br />
[/cc]</p>

<p>In 0.8.0, it&#8217;s more convenience: <br />
[cc lang=&#8221;clojure&#8221;]<br />
(defn-remote sc slacker.example.api/timestamp)<br />
[/cc]</p>

<p>To keep the core library compact, in 0.8.0, the cluster support has been moved to a standalone project <a href="https://github.com/sunng87/slacker-cluster">slacker-cluster</a>. </p>

<p>All above summarized my recent work in the slacker project. If you have any question with this library, feel free to drop me an email sunng@about.me .
</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2012/04/20/visualizing-openstreetmap-nanjing-contribution/">Visualizing OpenStreetMap Nanjing Contribution</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-20T00:00:00+08:00" pubdate data-updated="true">Apr 20<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>早上在prismatic上看到mapbox的一篇<a href="http://mapbox.com/blog/how-to-map-contributions-openstreetmap/" target="_blank">博客</a>，介绍通过TileMill可视化OSM的贡献者，非常酷。于是我在南京的地图上也做了一个这样的可视化。</p>

<p><img src="http://i.imgur.com/U2yXK.png" alt="" /></p>

<p>一个详细的大图在<a href="http://i.imgur.com/YnULm.png" target="_blank">这里</a>。虽然只做了南京的五个主要贡献者，基本上涵盖了大部分数据。</p>

<p>图例就不专门输出了<br />
[user = &#8216;Sunng&#8217;] { marker-fill: @magenta;} <br />
[user = &#8216;fuwuyuan&#8217;] { marker-fill: @blue;}<br />
[user = &#8216;sinopitt&#8217;] {marker-fill: @yellow;}<br />
[user = &#8216;larryy&#8217;] {marker-fill: @green;}<br />
[user = &#8216;zhengz&#8217;] {marker-fill: @red;}</p>

<p>MapBox家的东西真的非常酷，这家的技术以nodejs为主，围绕osm开发了不少产品。最近比较大的新闻，比如4sq转到osm上，其实就是转到这家的osm服务上。有兴趣你可以关注一下！
<img src="http://i.imgur.com/Hum2r.png" alt="" /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2012/04/12/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%9C%8D%E5%8A%A1%E5%99%A8/">多线程服务器</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-12T00:00:00+08:00" pubdate data-updated="true">Apr 12<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>写了挺长时间网络程序了，有些事到最近才弄明白，记录一下。</p>

<p>写一个高性能的服务器，传统的BIO方式基本上已经被淘汰了，很难获得理想的性能。所以现在都是以事件驱动的方式来写，在Linux上用epoll,Java平台上就是NIO。再向上，有一些包装的库，比如twisted比如libevent比如Java上的Netty。</p>

<p>Netty的server需要至少两组线程，BossPool和WorkerPool,。前者负责accept，后者负责r/w。通常的例子里，这就是仅有的两组线程。用户在框架之上的业务逻辑，写在handler里，以单线程的方式运行在worker线程上。</p>

<p>这样的方式在很多例子里很普遍。但是如果handler里的业务逻辑比较复杂，尤其是IO的等待过长(比如查询数据库)，就会由于在handler上阻塞的时间过长，导致服务器读写的效率下降。所以通常是不能在这样环境下的handler里写IO阻塞的代码。</p>

<p>解决这个问题，一种方式是多线程，一种是全异步化。后者最典型的例子就是nodejs，坦白说编程模型非常复杂，对开发者要求较高。一种相对简单的办法，就是以多线程的方式，增加CPU的利用效率，来平衡IO阻塞带来的影响。IO等待时间的比重越大，线程数就可以陪得越高。牺牲一些sy的CPU时间，换取更高的利用率。</p>

<p>但是随之而来了另一个问题，因为在handler中使用了多线程的模型。对顺序收到的包，交由不同的线程并行处理，就没有办法保证返回时的顺序。客户端就无法了解刚刚返回的包是对应哪个请求的。</p>

<p>这个情况也有两种办法处理。其一是在线程管理上做文章，采用一种折中的办法。对于每一个客户端连接来说，仍然是占用同一个线程来处理。这样首先任务不会占用worker线程，其次在整体上仍然提高了CPU的利用率。但是这样做的缺点是，在单一客户端看来，任务仍然是串行执行: 三个需要耗时500ms的请求同时顺序发出，第三个至少要在1500ms之后才能收到响应，客户端的latency比较高。</p>

<p>另一种，就是在应用协议层面做一个冗余字段，通常叫做serial id或者transaction id。客户端为每一个请求生成一个这样的id，并存储这个id对应的回调。服务器端不需要对包的顺序作任何关注，只需要把这个id原封不动地拷贝回去即可。这样，服务器就可以自由调度线程来处理请求。以上面的例子，在不繁忙的情况下，三个响应在500ms左右就都可以到达了。</p>

<p>这种方式对应用协议有特殊的要求，但是比较常见的协议都预留了这个字段，Diameter协议甚至留了两个这样的字段来便于代理的实现。</p>

<p>slacker 0.7.x基于aleph，由于aleph / lamina无法侵入协议层面，所以采用的都是顺序的客户端和服务器。这种方式编程非常简洁，协议设计简单，实现起来很快。但是作为RPC框架，一旦客户的函数阻塞较长，就会影响整体性能。0.8.0开始，通过新的协议和link库支持，slacker采用了transaction id的方式，服务器端默认使用并行处理，客户端不再依赖顺序指定响应和回调。尽管在一些CPU为局限的测试里性能有少许下降(与单线程相比，增加了调度的成本)，但是针对实际应用里IO等待较多的情况，新版本应该会表现出更好的综合性能。</p>

<p>以上这些，就是最近的心得，希望能解释清楚事件驱动服务器里的这些事情。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2012/04/02/slacker-performance-enhanced/">Slacker Performance Enhanced</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-02T00:00:00+08:00" pubdate data-updated="true">Apr 2<span>nd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In the slacker framework, performance issue becomes more and more critical as the basic features are almost completed. As mentioned in cnclojure meetup, I will focus on the performance enhancement in next release. </p>

<p>Now I have worked out a testable version. The new slacker core has been moved to a new NIO library, <a href="https://github.com/sunng87/link" target="_blank">link</a>. Compared with aleph, link is a thin wrapper of Netty. It takes some nice features from aleph (gloss codec dsl, elegant API), and drops the heavy abstraction, lamina. The new slacker client runs on a real nonblocking connection. Connection pooling is no longer needed.</p>

<p>I have some performance benchmark to visualize the improvement. The test was made on my laptop (Intel(R) Core(TM)2 Duo CPU     T5870  @ 2.00GHz). It ran 400,000 calls with 40 threads on a local slacker server.</p>

<p>slacker 0.7.0 (clojure 1.2, aleph 0.2.0): <strong>614005.059259msecs</strong>
slacker 0.7.1-SNAPSHOT (clojure 1.3, aleph 0.2.1-beta2): <strong>409110.909142msecs</strong>
slacker 0.8.0-SNAPSHOT (clojure 1.3, link 0.2.0-SNAPSHOT): <strong>42468.401522msecs</strong></p>

<p><img src="http://i.imgur.com/gMtdo.jpg" alt="tps chart" /></p>

<p>Check out the new slacker on the <a href="https://github.com/sunng87/slacker/tree/0.8-dev" target="_blank">0.8-dev</a> branch. </p>

<p></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2012/03/22/%E4%B8%BAwebworker%E8%AE%BE%E7%BD%AE%E6%AD%A3%E7%A1%AE%E7%9A%84%E8%B7%AF%E5%BE%84/">为WebWorker设置正确的路径</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-22T00:00:00+08:00" pubdate data-updated="true">Mar 22<span>nd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>WebWorker的路径通常是写在代码源文件中，而且这个路径并非其相对父js文件的相对路径，而似乎是相对页面的路径。所以指定一个正确的可随处部署的路径变得有些麻烦。昨天有人给HeatCanvas提了这个问题我才想到上网搜索了一下，有一个还算挺不错的办法。</p>

<p>写一个getPath函数，从document里找到父js的路径，拼到Worker的名字上。对heatcanvas.js这个文件来说就是：</p>

<p>[cc lang=&#8221;javascript&#8221;]<br />
HeatCanvas.getPath = function() {<br />
    var scriptTags = document.getElementsByTagName(&#8220;script&#8221;);<br />
    for (var i=0; i<scriptTags.length; i++) {<br />
        var src = scriptTags[i].src;<br />
        var pos = src.indexOf(&#8220;heatcanvas.js&#8221;);<br />
        if (pos > 0) {<br />
            return src.substring(0, pos);<br />
        }<br />
    }<br />
    return &#8220;&#8221;;<br />
};<br />
[/cc]</p>

<p>因此现在HeatCanvas已经解决了这个路径问题，现在这个库应该更好用了。当然如果你改了我的文件名我就无话可说了。
</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/blog/page/4/">&larr; Older</a>
    
    <a href="/blog/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/blog/page/2/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/blog/2013/07/05/grunt-for-requirejs-projects/">Grunt for Requirejs Projects</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/06/29/%E7%BB%99-raspberry-pi-%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AA%E6%98%BE%E7%A4%BA-ip-%E7%9A%84%E6%B6%B2%E6%99%B6%E5%B1%8F/">给 Raspberry Pi 添加一个显示 IP 的液晶屏</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/06/07/%E7%BA%B8%E4%B8%8A%E5%BE%97%E6%9D%A5%E7%BB%88%E8%A7%89%E6%B5%85/">纸上得来终觉浅</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/04/24/checkout-ring-adapter-for-jetty-9/">Checkout Ring Adapter for Jetty 9</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/04/12/ann-handlebars-clojure-api/">[ANN] Handlebars Clojure API</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/sunng87">@sunng87</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'sunng87',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/blog/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>On Delicious</h1>
  <div id="delicious"></div>
  <script type="text/javascript" src="http://feeds.delicious.com/v2/json/classicing?count=3&amp;sort=date&amp;callback=renderDeliciousLinks"></script>
  <p><a href="http://delicious.com/classicing">My Delicious Bookmarks &raquo;</a></p>
</section>




  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Sun Ning -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'sunng-blog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
