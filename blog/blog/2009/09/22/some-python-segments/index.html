
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Some Python Segments - Here comes the Sun</title>
  <meta name="author" content="Sun Ning">

  
  <meta name="description" content="import MySQLdb
import subprocess
from smtplib import *
from datetime import date, timedelta class StatEntry(object): def __init__(self, name, count &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://sunng87.github.io/blog//blog/2009/09/22/some-python-segments">
  <link href="/blog/favicon.png" rel="icon">
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/blog/atom.xml" rel="alternate" title="Here comes the Sun" type="application/atom+xml">
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/blog/">Here comes the Sun</a></h1>
  
    <h2>Sun Ning's web log</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/blog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:sunng87.github.io/blog/" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/blog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Some Python Segments</h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-09-22T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


<div class="entry-content"><p><pre class="brush:python">
import MySQLdb
import subprocess
from smtplib import *
from datetime import date, timedelta</pre></p>

<p>class StatEntry(object):<br />
    def __init__(self, name, count):<br />
        self.name = name<br />
        self.count = count<br />
    def __str__(self):<br />
        return &#8220;%s\t%d&#8221; % (self.name, self.count)</p>

<p>def fetchdb(date):<br />
    conn = MySQLdb.connect(host=&#8221;localhost&#8221;, user=&#8221;root&#8221;, passwd=&#8221;acd&#8221;, db=&#8221;cls&#8221;)<br />
    cursor = conn.cursor()<br />
    cursor.execute(&#8220;SELECT link, count(*) FROM sdocom WHERE DATE(logtime) = DATE(&#8216;%s&#8217;) GROUP BY link&#8221; % date)<br />
    rows = cursor.fetchall()<br />
    result = map(lambda x: StatEntry(*x), rows)<br />
    return result</p>

<p>def archive(datelist):<br />
    for date in datelist:<br />
        subprocess.call([&#8220;gzip&#8221;, &#8220;cls-&#8220;+date+&#8221;.log&#8221;])</p>

<p>def sendmail(results):<br />
    mailcontent = reduce(lambda x,y: x+str(y)+&#8221;\n&#8221;, results, &#8220;&#8221;)<br />
    smtp = SMTP(&#8220;your.smtp.server&#8221;)<br />
    smtp.login(&#8220;user&#8221;,&#8221;passwd&#8221;)<br />
    smtp.sendmail(&#8220;cls-no-reply@smtp.server&#8221;, [&#8220;your@mail.server&#8221;], mailcontent)<br />
    smtp.quit()</p>

<p>def dumpall(data):<br />
    content = reduce(lambda x,y: x+str(y)+&#8221;\n&#8221;, data, &#8220;&#8221;)<br />
    print content</p>

<p>def main():<br />
    yesterday = str(date.today()-timedelta(1))<br />
    results = fetchdb(yesterday)<br />
    #dumpall(results)<br />
    sendmail(results)<br />
    archive([yesterday])</p>

<p>if __name__ == &#8216;__main__&#8217;:<br />
    main()
</p>

<p>As log file was imported to database automatically by other process, the script retrieves statistical data from mysql db and sends the result to your mail box via smtp. Also, log file would be compressed by gzip to minimize storage overhead. Add it to crontab, you will get daily statistical report.</p>

<p>This example shows you basic usage of mysql-python lib, smtplib and how to calculate yesterday by datetime.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Sun Ning</span></span>

      








  


<time datetime="2009-09-22T00:00:00+08:00" pubdate data-updated="true"></time>
      

<span class="categories">
  
    <a class='category' href='/blog/blog/categories/ba-xi/'>把戏</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://sunng87.github.io/blog//blog/2009/09/22/some-python-segments/" data-via="Sunng" data-counturl="http://sunng87.github.io/blog//blog/2009/09/22/some-python-segments/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/blog/2009/09/20/%E7%83%A7%E9%A5%AD%E5%86%8D/" title="Previous Post: 烧饭再">&laquo; 烧饭再</a>
      
      
        <a class="basic-alignment right" href="/blog/blog/2009/09/23/performance-visualization-with-gnuplot/" title="Next Post: Performance Visualization with Gnuplot">Performance Visualization with Gnuplot &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p>Ning Sun. Programmer. Map enthusiast. (<a href="http://sunng.info/">more</a>)</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/blog/2014/08/02/rust-with-docker/">在 Docker 中安装和使用 Rust Nightly 版本</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2014/07/08/microservice-and-slacker-cluster/">Clojure Microservice Architecture With Slacker Cluster</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2014/07/07/new-android-apps/">Mapzei 和 观察者</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2014/07/01/extend-linux-ephemeral-ports/">扩展 Linux Ephemeral 端口限制</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2014/06/09/grouping-in-slacker-0-dot-12/">Slacker Cluster 0.12: Grouping</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/sunng87">@sunng87</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'sunng87',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/blog/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>On Delicious</h1>
  <div id="delicious"></div>
  <script type="text/javascript" src="http://feeds.delicious.com/v2/json/classicing?count=3&amp;sort=date&amp;callback=renderDeliciousLinks"></script>
  <p><a href="http://delicious.com/classicing">My Delicious Bookmarks &raquo;</a></p>
</section>




  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Sun Ning -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'sunng-blog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://sunng87.github.io/blog//blog/2009/09/22/some-python-segments/';
        var disqus_url = 'http://sunng87.github.io/blog//blog/2009/09/22/some-python-segments/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
