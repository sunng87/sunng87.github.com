<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Using Yan in Ruby Web Application</title>
  <meta name="description" content="I will show you the usage of Yan captcha service. In this tutorial, it's based on a simple ruby web application of the Sinatra web framework.">

  <link rel="stylesheet" href="/blog/css/main.css">
  <link rel="canonical" href="http://sunng.info//blog/blog/2009/12/21/use-yan-in-ruby-web-application/">
  <link rel="alternate" type="application/rss+xml" title="Here comes the Sun" href="http://sunng.info//blog/feed.xml" />
</head>

  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/blog/">Here comes the Sun</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

    </nav>

  </div>

</header>

    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Using Yan in Ruby Web Application</h1>
    <p class="post-meta">Dec 21, 2009</p>
  </header>

  <article class="post-content">
    <p>I will show you the usage of Yan captcha service. In this tutorial, it's based on a simple ruby web application of the Sinatra web framework.</p>

<p>Before we start to use the service, it is necesary to get Yan running. Download the code from <a href="http://bitbucket.org/sunng/yan/" target="_blank">the project page</a>, then build and run it with maven:
<em>mvn jetty:run</em></p>

<p>To enable the application to use Yan, we have to register our application to get an API Key. If you use Yan 0.3, there is a secret registration page at <em>http://localhost:8080/yan/reg.jsp</em> The page is protected by HTTP Basic Authentication, the username and password are store in 'realm.properties' which is considered to locate in the root directory. Open the file you can see the plain text username and password. If you are running the latest development version, there is no long any UI for API Key creation, but restful interface. This won't be hard to you, pickup your tools such as curl or poster (a firefox extension) to send a HTTP request. Take curl as example, do it like this:
<em>curl -X PUT "http://localhost:8080/yan/apikey/" -d "SinatraTestApp" -u "username:password"</em></p>

<p>If it works, you will get a line of json:
<em>{"apikey":"b251b0dc2eed31cac38555b61d4fa6a453923bfd","appName":"SinatraTestApp"}</em>
Save this apikey.</p>

<p>Sinatra is generally considered to be the world's lightest and smallest web framework. And our application is rather simple. Just check the code:
<pre class="brush:ruby">require "rubygems"
require "sinatra"
require "net/http"
require "yaml"</pre></p>

<p>apikey='b251b0dc2eed31cac38555b61d4fa6a453923bfd'</p>

<p>get '/' do<br />
	conn = Net::HTTP.new('localhost', 8080)<br />
	q = "ip=#{@env['REMOTE_ADDR']}&amp;apikey=#{apikey}&amp;alt=yaml&amp;mode=0"<br />
	resp, data = conn.get("/yan/ticket?#{q}")<br />
	@ticket = YAML::load(data)<br />
	haml :sinatra_captcha<br />
end</p>

<p>post '/' do<br />
	conn = Net::HTTP.new('localhost', 8080)<br />
	q = "ip=#{@env['REMOTE_ADDR']}&amp;apikey=#{apikey}&amp;key=#{params['key']}&amp;code=#{params['captcha']}"<br />
	resp, data = conn.get("/yan/validate?#{q}")<br />
	data<br />
end</p>

<p>use_in_file_templates!<br />
__END__</p>

<p>@@ sinatra_captcha<br />
%html<br />
	%head<br />
		%title Yan Captcha on Sinatra<br />
	%body<br />
		%form{:action=&gt;"/", :method=&gt;"post"}<br />
			%p<br />
				Username:<br />
				%input{:name=&gt;"username", :type=&gt;"text"}<br />
			%p<br />
				Password:<br />
				%input{:name=&gt;"password", :type=&gt;"password"}<br />
			%p<br />
				Captcha:<br />
				%img{:src=&gt;@ticket['url']}<br />
				%br<br />
				%input{:name=&gt;"captcha", :type=&gt;"text"}<br />
				%input{:name=&gt;"key", :type=&gt;"hidden", :value=&gt;@ticket['key']}<br />
				%input{:type=&gt;'submit'}

There are two parts of this application: ruby code and haml. I just use in-file-template for convenience. We define a get handler and a post handler on the path '/'. The get handler will request a ticket from Yan which contains captcha image url and ticket key. The post handler will extract user input and submit the Yan's validator and return user the result. And the HAML code is template for page rendering after GET request.</p>

<p>Maybe you need to install sinatra and some dependency:
<em>sudo gem install sinatra haml</em></p>

<p>Run the code with a build-in WEBrick
<em>ruby sinatra-yan.rb</em></p>

<p>Browse to the default url, test it:</p>

<p><img class="alignnone" src="http://farm3.static.flickr.com/2766/4203612734_3237ed066c_o.png" alt="" width="459" height="268" /></p>

<p>For another similar tutorial using python, check Yan's wiki page:
<a href="http://bitbucket.org/sunng/yan/wiki/SampleCode" target="_blank">http://bitbucket.org/sunng/yan/wiki/SampleCode</a></p>

<p>Thank you for your support. btw, today is my dear girl friend's birthday, I just wish her happy everyday.</p>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Here comes the Sun</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Here comes the Sun</li>
          <li><a href="mailto:"></a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          

          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text"></p>
      </div>
    </div>

  </div>

</footer>

  </body>

</html>
