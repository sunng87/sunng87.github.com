<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Clojure on CloudFoundry</title>
  <meta name="description" content="In this article, I will show you how to develop and deploy clojure web application on CloudFoundry. As you may know, CloudFoundry is an opensource PaaS backe...">

  <link rel="stylesheet" href="/blog/css/main.css">
  <link rel="canonical" href="http://sunng87.github.io/blog//blog/blog/2012/01/13/clojure-on-cloudfoundry/">
  <link rel="alternate" type="application/rss+xml" title="Here comes the Sun" href="http://sunng87.github.io/blog//blog/feed.xml" />
</head>

  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/blog/">Here comes the Sun</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

    </nav>

  </div>

</header>

    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Clojure on CloudFoundry</h1>
    <p class="post-meta">Jan 13, 2012</p>
  </header>

  <article class="post-content">
    <p>In this article, I will show you how to develop and deploy clojure web application on CloudFoundry. As you may know, CloudFoundry is an opensource PaaS backed by VMWare. Java, Ruby and Nodejs are officially supported. As a JVM language, clojure is born to be also available on this platform, although it's not listed. </p>

<p>CloudFoundry accepts a .war file for Java web application deployment. So you don't need the ring-jetty-adaptor and a procfile as heroku requires. To help your development and deployment, I strongly recommend the lein-ring plugin:</p>

<p>[cc lang="clojure"]<br />
  :dev-dependencies [[lein-ring "0.5.4"]]<br />
[/cc]</p>

<p>CloudFoundry provides backend services like mysql, redis, mongodb and more. The connection information are stored as environment variables. <a href="http://env.cloudfoundry.com/env" target="_blank">Here</a> you can find a subset of them. </p>

<p>Take mongodb as example, connection information (host, port, username and password) are encoded as JSON, stored in environment variables. You can get them with this function:<br />
[cc lang="clojure"]<br />
(defn mongo-config [key]<br />
  (if-let [services (System/getenv "VCAP_SERVICES")]<br />
    (let [services-dict (json/read-json services false)]<br />
      (-> services-dict<br />
        (get "mongodb-1.8")<br />
        first<br />
        (get "credentials")<br />
        (get key)))))<br />
[/cc]</p>

<p>In the server bootstrap function, create the mongodb connection:<br />
[cc lang="clojure"]<br />
(defn app-init []<br />
  (def db-conn (make-connection<br />
                 (or (mongo-config "db") "lazypress")<br />
                   :host (or (mongo-config "hostname") "localhost")<br />
                   :port (or (mongo-config "port") 27017)))<br />
  (when-not (nil? (mongo-config "username"))<br />
    (authenticate db-conn<br />
      (mongo-config "username")<br />
      (mongo-config "password")))<br />
[/cc]<br />
By adding check for nil, local databased is also supported. This is pretty convenience for local development. These environment variables are consistent on all cloudfoundry application, so it's possible to deploy the application on multiple accounts without any changes.</p>

<p>Then you can add your web stuff just like standard clojure web development. (If you are using compojure, place your static files under resource/public.)</p>

<p>Finally, package it. (Suppose your application is named as "lazypress")<br />
[cc lang="bash"]<br />
lein ring uberwar lazypress.war<br />
[/cc]</p>

<p>Use the vmc tool to deploy it:<br />
[cc lang="bash"]<br />
vmc update lazypress<br />
[/cc]</p>

<p>For more usage about the vmc tool, you can read <a href="http://blog.cloudfoundry.com/post/13481010498/simplified-application-deployment-with-cloud-foundry-manifest" target="_blank">this article</a>.</p>

<p>So you have finished deploying your clojure web application to cloudfoundry.</p>

<p>Backed by spring and vmware, cloudfoundry is more Java-friendly than other PaaS like heroku. You don't have to start a Java process by yourself ("lein run" isn't a graceful way to start your app in product environment). And you don't have to worry about your web container settings (configure jetty with limited options via ring-jetty-adaptor). All you have to do is package the application as a portable war file, which you can deploy to tomcat, glassfish, and also cloudfoundry. The vmc tool could detect you war file and handle it correctly.</p>

<p></p>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Here comes the Sun</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Here comes the Sun</li>
          <li><a href="mailto:"></a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          

          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text"></p>
      </div>
    </div>

  </div>

</footer>

  </body>

</html>
