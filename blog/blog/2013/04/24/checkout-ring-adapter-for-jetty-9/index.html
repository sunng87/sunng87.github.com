<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Checkout Ring Adapter for Jetty 9</title>
  <meta name="description" content="The Clojure world has been using Jetty 7 for quite a long time because it's supported by the Ring development team. However, Jetty 9 brings us exciting featu...">

  <link rel="stylesheet" href="/blog/css/main.css">
  <link rel="canonical" href="http://sunng.info//blog/blog/2013/04/24/checkout-ring-adapter-for-jetty-9/">
  <link rel="alternate" type="application/rss+xml" title="Here comes the Sun" href="http://sunng.info//blog/feed.xml" />
</head>

  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/blog/">Here comes the Sun</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

    </nav>

  </div>

</header>

    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Checkout Ring Adapter for Jetty 9</h1>
    <p class="post-meta">Apr 24, 2013</p>
  </header>

  <article class="post-content">
    <p>The Clojure world has been using Jetty 7 for quite a long time because it's supported by the Ring development team. However, Jetty 9 brings us exciting features like WebSocket and SPDY. In order to use websocket in my Clojure web application, I built this adapter last weekend.</p>

<p>[info.sunng/ring-jetty9-adapter "0.1.0"]</p>

<p>The API for Clojure is still consistent with the one for jetty 7.<br />
[cc lang="clojure"]<br />
(use 'ring.adapter.jetty9)<br />
(run-jetty app {})<br />
[/cc]</p>

<p>Options supported in jetty 9 are almost same as jetty 7 except the configurator is dropped. And a new "WebSockets" option is added. Accepting a map of context path and websocket class, it enables websocket protocol in your web application.</p>

<p>[cc lang="clojure"]<br />
(use 'ring.adapter.jetty9)<br />
(run-jetty app {:websockets {"/loc" LocationTracker}})<br />
[/cc]</p>

<p>Due to the lack of WebSocket API standards, I don't spend time on the WebSocket abstraction. Just use Jetty's internal API for websocket. Here is a typical implementation of websocket listener.<br />
<figure class='code-highlight-figure'><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="c1">;; sample code</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">xxx.ws.location</span><span class="w">
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>  </span><span class="p">(</span><span class="no">:gen-class</span><span class="w">
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>   </span><span class="no">:name</span><span class="w"> </span><span class="n">xxx.LocationTracker</span><span class="w">
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>   </span><span class="no">:init</span><span class="w"> </span><span class="n">init</span><span class="w">
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>   </span><span class="no">:state</span><span class="w"> </span><span class="n">state</span><span class="w">
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>   </span><span class="no">:extends</span><span class="w"> </span><span class="n">org.eclipse.jetty.websocket.api.WebSocketAdapter</span><span class="w">
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>   </span><span class="no">:prefix</span><span class="w"> </span><span class="n">ws-</span><span class="w">
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>   </span><span class="no">:exposes-methods</span><span class="w"> </span><span class="p">&#x7b;</span><span class="n">onWebSocketConnect</span><span class="w"> </span><span class="n">superOnWebSocketConnect</span><span class="p">&#x7d;)</span><span class="w">
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>  </span><span class="p">(</span><span class="no">:require</span><span class="w"> </span><span class="p">[</span><span class="n">clojure.data.json</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">json</span><span class="p">]</span><span class="w">
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>            </span><span class="p">[</span><span class="n">clojure.tools.logging</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">logging</span><span class="p">]</span><span class="w">
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'>            </span><span class="p">[</span><span class="n">monger.collection</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">mc</span><span class="p">])</span><span class="w">
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>  </span><span class="p">(</span><span class="no">:import</span><span class="w"> </span><span class="p">(</span><span class="nf">org.eclipse.jetty.websocket.api</span><span class="w"> </span><span class="n">WebSocketAdapter</span><span class="p">)</span><span class="w">
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'>           </span><span class="p">(</span><span class="nf">java.util</span><span class="w"> </span><span class="n">UUID</span><span class="p">)))</span><span class="w">
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'></span>
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">ws-init</span><span class="w"> </span><span class="p">[]</span><span class="w">
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'>  </span><span class="p">[[]</span><span class="w"> </span><span class="p">&#x7b;</span><span class="no">:client-id</span><span class="w"> </span><span class="p">(</span><span class="nb">str</span><span class="w"> </span><span class="p">(</span><span class="nf">UUID/randomUUID</span><span class="p">))&#x7d;])</span><span class="w">
</div></div><div data-line='18' class='code-highlight-row numbered'><div class='code-highlight-line'></span>
</div></div><div data-line='19' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">ws-onWebSocketConnect</span><span class="w"> </span><span class="p">[</span><span class="n">this</span><span class="w"> </span><span class="n">session</span><span class="p">]</span><span class="w">
</div></div><div data-line='20' class='code-highlight-row numbered'><div class='code-highlight-line'>  </span><span class="p">(</span><span class="nf">.superOnWebSocketConnect</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">session</span><span class="p">)</span><span class="w">
</div></div><div data-line='21' class='code-highlight-row numbered'><div class='code-highlight-line'>  </span><span class="p">(</span><span class="nf">logging/warn</span><span class="w"> </span><span class="s">"new connection: "</span><span class="w"> </span><span class="p">(</span><span class="nf">get-client-id</span><span class="w"> </span><span class="n">this</span><span class="p">))</span><span class="w">
</div></div><div data-line='22' class='code-highlight-row numbered'><div class='code-highlight-line'></span>
</div></div><div data-line='23' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">ws-onWebSocketText</span><span class="w"> </span><span class="p">[</span><span class="n">this</span><span class="w"> </span><span class="n">message</span><span class="p">]</span><span class="w">
</div></div><div data-line='24' class='code-highlight-row numbered'><div class='code-highlight-line'>  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">msg</span><span class="w"> </span><span class="p">(</span><span class="nf">json/read-json</span><span class="w"> </span><span class="n">message</span><span class="p">)]</span><span class="w">
</div></div><div data-line='25' class='code-highlight-row numbered'><div class='code-highlight-line'>    </span><span class="p">(</span><span class="nf">case</span><span class="w"> </span><span class="p">(</span><span class="no">:type</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w">
</div></div><div data-line='26' class='code-highlight-row numbered'><div class='code-highlight-line'>      </span><span class="n">...</span><span class="p">)))</span><span class="w">
</div></div><div data-line='27' class='code-highlight-row numbered'><div class='code-highlight-line'></span>
</div></div><div data-line='28' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">ws-onWebSocketClose</span><span class="w"> </span><span class="p">[</span><span class="n">this</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="n">reason</span><span class="p">]</span><span class="w">
</div></div><div data-line='29' class='code-highlight-row numbered'><div class='code-highlight-line'>  </span><span class="p">(</span><span class="nf">logging/debug</span><span class="w"> </span><span class="s">"close socket"</span><span class="p">))</span></div></div></pre></div></figure>


<p>Since Jetty will create new instance of adapter for each connection, it requires heavy usage of "gen-class" . Remember to add the namespace to AOT compilation. Detailed Jetty API spec can be found <a href="http://download.eclipse.org/jetty/stable-9/apidocs/org/eclipse/jetty/websocket/api/WebSocketAdapter.html" target="_blank">here</a>.<br />
 
And also find the project is <a href="https://github.com/sunng87/ring-jetty9-adapter" target="_blank">here</a>.</p>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Here comes the Sun</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Here comes the Sun</li>
          <li><a href="mailto:"></a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          

          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text"></p>
      </div>
    </div>

  </div>

</footer>

  </body>

</html>
