<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Some Python Segments</title>
  <meta name="description" content="import MySQLdbimport subprocessfrom smtplib import *from datetime import date, timedelta">

  <link rel="stylesheet" href="/blog/css/main.css">
  <link rel="canonical" href="http://sunng.info//blog/blog/2009/09/22/some-python-segments/">
  <link rel="alternate" type="application/rss+xml" title="Here comes the Sun" href="http://sunng.info//blog/feed.xml" />
</head>

  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/blog/">Here comes the Sun</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

    </nav>

  </div>

</header>

    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Some Python Segments</h1>
    <p class="post-meta">Sep 22, 2009</p>
  </header>

  <article class="post-content">
    <p><pre class="brush:python">
import MySQLdb
import subprocess
from smtplib import *
from datetime import date, timedelta</pre></p>

<p>class StatEntry(object):<br />
    def __init__(self, name, count):<br />
        self.name = name<br />
        self.count = count<br />
    def __str__(self):<br />
        return "%s\t%d" % (self.name, self.count)</p>

<p>def fetchdb(date):<br />
    conn = MySQLdb.connect(host="localhost", user="root", passwd="acd", db="cls")<br />
    cursor = conn.cursor()<br />
    cursor.execute("SELECT link, count(*) FROM sdocom WHERE DATE(logtime) = DATE('%s') GROUP BY link" % date)<br />
    rows = cursor.fetchall()<br />
    result = map(lambda x: StatEntry(*x), rows)<br />
    return result</p>

<p>def archive(datelist):<br />
    for date in datelist:<br />
        subprocess.call(["gzip", "cls-"+date+".log"])</p>

<p>def sendmail(results):<br />
    mailcontent = reduce(lambda x,y: x+str(y)+"\n", results, "")<br />
    smtp = SMTP("your.smtp.server")<br />
    smtp.login("user","passwd")<br />
    smtp.sendmail("cls-no-reply@smtp.server", ["your@mail.server"], mailcontent)<br />
    smtp.quit()</p>

<p>def dumpall(data):<br />
    content = reduce(lambda x,y: x+str(y)+"\n", data, "")<br />
    print content</p>

<p>def main():<br />
    yesterday = str(date.today()-timedelta(1))<br />
    results = fetchdb(yesterday)<br />
    #dumpall(results)<br />
    sendmail(results)<br />
    archive([yesterday])</p>

<p>if __name__ == '__main__':<br />
    main()
</p>

<p>As log file was imported to database automatically by other process, the script retrieves statistical data from mysql db and sends the result to your mail box via smtp. Also, log file would be compressed by gzip to minimize storage overhead. Add it to crontab, you will get daily statistical report.</p>

<p>This example shows you basic usage of mysql-python lib, smtplib and how to calculate yesterday by datetime.</p>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Here comes the Sun</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Here comes the Sun</li>
          <li><a href="mailto:"></a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          

          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text"></p>
      </div>
    </div>

  </div>

</footer>

  </body>

</html>
