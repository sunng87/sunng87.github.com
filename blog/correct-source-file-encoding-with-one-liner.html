<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Correct source file encoding with one liner</title>
        <link rel="stylesheet" href="https://sunng.info/blog/theme/css/main.css" />
        <link href="https://sunng.info/blog/atom.xml" type="application/atom+xml" rel="alternate" title="Here Comes the Sun Atom Feed" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://sunng.info/blog/">Here Comes the Sun </a></h1>
                <nav><ul>
                    <li class="active"><a href="https://sunng.info/blog/category/misc.html">misc</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://sunng.info/blog/correct-source-file-encoding-with-one-liner.html" rel="bookmark"
           title="Permalink to Correct source file encoding with one liner">Correct source file encoding with one liner</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2011-03-08T00:00:00+08:00">
                Published: Tue 08 March 2011
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://sunng.info/blog/author/ning-sun.html">Ning Sun</a>
        </address>
<p>In <a href="https://sunng.info/blog/category/misc.html">misc</a>.</p>

</footer><!-- /.post-info -->      <ul>
<li>把戏
tags:</li>
<li>bash</li>
<li>shell
published: true
comments: true</li>
</ul>
<hr />
<p><p><a href="http://amoeba.meidusa.com/wordpress/">Amoeba</a>项目最早的代码可以追溯到2008年了，其中有多个作者贡献代码，因为一直在Windows下开发，所以没有使用UTF8编码，最近大家统一到UTF8，遇到了代码编码不正确的问题。</p></p>
<p>于是我们需要统一解决一下这个问题：
<code>iconv -f gbk -t utf8 -o ConnectionManager.java ConnectionManager.java</code></p>

<p>这样可以把gbk编码的源文件转换为UTF8，原地转换。</p>

<p>推广到整个代码目录，用find和xargs做，xargs通过-I来制定一个占位符。
<code>find . -name "*.java" -type f -perm +600 -print | xargs -I _ iconv -f gbk -t utf8 -o _ -c _</code></p>

<p>结果发现iconv运行中报了错，进一步检查发现一部分代码正常转换了，另一部分却乱码了。原来，两个作者的代码分别是gbk和gb2312，这iconv转换的时候两种编码并不兼容。这就麻烦了，必须对代码分别处理才可以，区别代码的编码，暂时就用Java源文件里的作者名字。又看了一下find似乎没有对文件内容过滤的条件，不过不要紧，我们可以用xargs做：
<code>find . -name "*.java" -type f -perm +600 -print | xargs -I _ sh -c 'grep -q hexianmao _ && iconv -f gb2312 -t utf8 -o _ -c _ '</code></p>

<p>对这位hexianmao作者的代码，我们利用grep进程的返回值来进行判断。grep的-q参数相当于>/dev/null。这里有一个tricky的地方，再xargs里我们不能直接用&&来组合命令，不过可以通过sh -c这样的方式，并且其中的占位符会被xargs合适地替换掉。</p>

<p>这样执行之后，这位作者的gb2312代码就被成功转换了。而另一部分作者的gbk代码也可以用同样方式解决了。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://sunng.info/blog/atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://github.com/sunng87">Github</a></li>
                            <li><a href="https://twitter.com/sunng">Twitter</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>