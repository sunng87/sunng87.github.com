
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Here comes the Sun</title>
  <meta name="author" content="Sun Ning">

  
  <meta name="description" content="在compojure 0.6.0里，默认的middleware被移除了。因为还没有正式发布，所以网上几乎没有相关的文档说明，而0.5.x的例子已经没能正常工作了。 [cc lang=&#8221;clojure&#8221;]
;&#8230;
(defroutes root (GET &# &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://sunng87.github.io/blog//blog/page/16">
  <link href="/blog/favicon.png" rel="icon">
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/blog/atom.xml" rel="alternate" title="Here comes the Sun" type="application/atom+xml">
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/blog/">Here comes the Sun</a></h1>
  
    <h2>Sun Ning's web log</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/blog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:sunng87.github.io/blog/" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/blog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2011/02/02/breaking-changes-in-compojure-0-6-0/">Breaking Changes in Compojure 0.6.0</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-02-02T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>在compojure 0.6.0里，默认的middleware被移除了。因为还没有正式发布，所以网上几乎没有相关的文档说明，而0.5.x的例子已经没能正常工作了。</p>

<p>[cc lang=&#8221;clojure&#8221;]<br />
;&#8230;<br />
(defroutes root<br />
    (GET &#8220;/&#8221; {params :params} (str params)))</p>

<p>(run-jetty root {:port 8080}))<br />
[/cc]</p>

<p>这样在0.5.x中可以正确运行的代码，在0.6.0中params变成了空的map。</p>

<p>在0.6.0中，compojure引入了一个新的ns叫做compojure.handler，其中包含两个function， api和site，它们包含了一些默认的middleware，适合相应的开发场景。为了让代码能够工作，在新版本中：<br />
[cc lang=&#8221;clojure&#8221;]<br />
;&#8230;<br />
(use &#8216;compojure.handler)<br />
(defroutes root<br />
    (GET &#8220;/&#8221; {params :params} (str params)))</p>

<p>(def app (site root))</p>

<p>(run-jetty root {:port 8080}))<br />
[/cc]</p>

<p>详细可以在这里找到
<a href="https://groups.google.com/group/compojure/browse_thread/thread/4f8574d808ddf53e">https://groups.google.com/group/compojure/browse_thread/thread/4f8574d808ddf53e</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2011/01/22/%E5%8C%85%E7%AE%A1%E7%90%86%E4%B8%8E%E8%B7%AF%E5%BE%84%E7%AE%A1%E7%90%86/">包管理与路径管理</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-01-22T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>现在几乎每一种语言都有一些依赖管理工具，或者是中央的包仓库。比如这些：
<ul>
<li>Java: maven, ivy, gradle</li>
<li>Ruby: gems</li>
<li>Python: easy_install, pip</li>
<li>Clojure: leinigen</li>
<li>Groovy: maven, grape, gradle</li>
<li>Hashkell: cabal</li>
<li>PHP: pear</li>
<li>Nodejs: npm</li>
</ul></p>

<p>这些工具在管理包和路径时都会采用各不相同的策略，有的是通过自身实现，有的是借助语言平台本身的特点。</p>

<p><h3>Java</h3>
其中最注明的Maven，它的方式是在POM文件中定义你的依赖，Maven会在本地仓库中维护这些依赖。Maven的本地仓库默认是在$HOME/.m2/repository目录下，是用户独立的，当然要下载一个依赖也不需要root权限。而在通过Maven运行Java项目时，Maven插件会自动管理classpath，你并不需要把这些依赖从本地仓库里拷贝出来而单独维护一个所谓lib目录（这样也不好管理）。这是Maven的方式，目前看来，这也是最经典的一种方式。除了maven本身的特性以外，这也和Java的classpath机制有关。</p>

<p>最近势头很猛的Java构建工具gradle，方式也与Maven类似，它会把下载的依赖存放在$HOME/.gradle/cache目录里，并自动管理classpath。</p>

<p>同样是Java，与maven相对应的是ant+ivy。ivy可以为你管理依赖，但是ivy不会帮你管理classpath。ivy的包管理，是以project为scope的，你需要维护一个lib目录来存放这些下载的包，再通过传统的ant的方式去管理classpath，从而使项目可以进行编译和运行。</p>

<p>在Java世界里，还有一个特别的工具叫做grape，它是专门用于groovy的轻量级的依赖解决方案。grape是以脚本为scope，在需要依赖的脚本中通过@Grab声明依赖，grape工具可以从maven仓库中下载依赖到$HOME/.groovy/grapes中，并把相关的依赖加入groovy的classpath。除此以外，grape还有一个命令行工具帮助你手动下载依赖到本地仓库。grape的内部是基于ivy的，不过它的方式比ant要自动化很多。</p>

<p>在Java世界里还有一个特例，是Clojure的依赖管理工具leiningen。leiningen本身也比较简单，它的方式与ivy相同，会解析project.clj文件中定义的依赖关系，并下载到当前的工程目录下的lib中。lein是鼓励通过uberjar的方式把依赖统统打包的，所以它并没有classpath的管理功能。</p>

<p>总体来说，Java世界的工具和Java是相似的，其最大特点就是System independent，安装包不需要root权限，每次的运行都需要管理classpath。作为开发人员，classpath中有哪些可以访问的类库是可以控制的，这也使Java程序的移植性得到良好的控制和管理。</p>

<p><h3>Python</h3>
与Java不同，Python通常作为系统分发的一部分，他的包管理和PATH管理要相对混乱一些。通常我们有两种方式来安装一个Python的软件包：
<ul>
<li>sudo apt-get install python-redis</li>
<li>sudo easy_install redis</li>
</ul>
一种是通过系统的包管理工具（如apt-get）从系统的软件仓库里安装，一种是通过python自己的包管理工具（如easy_install / pip）从Python Cheese Shop中下载安装。这两种安装方式有什么不同呢。以Ubuntu为例，通过apt-get安装的python包通常会被放在 /usr/share/pyshared 或 /usr/lib/python2.6/dist-packages 中，相对应的，由easy_install安装的Python包，则存放在 /usr/local/lib/python2.6/dist-packages 中。Python启动后可以通过查看sys.path来了解当前的path情况。</p>

<p>除了安装到系统目录，easy_install可以通过 &#8211;user 选项来把软件包安装到用户目录 $HOME/.local/lib/python2.6/site-packages。不过无论是系统级别还是用户级别，python都很难在启动时管理Path，即任何时候python都可以访问安装在系统中的所有软件包。这导致了混乱的情况，导致编写的python软件难以进行依赖管理和移植（即使没有定义在setup.py中，很多依赖还是可以访问的）。</p>

<p>由此virtualenv营运而生，virtualenv帮助你创建一个独立的python运行环境。激活这个小环境之后，easy_install/pip仅仅安装软件到小环境，python仅能访问环境内部的site-packages，这样整个环境中的依赖关系就非常清楚，也保障了程序的移植性。这样，就将原本系统scope的python包管理级别改进为项目级别。我之前写的jip也是将依赖下载或拷贝到virtualenv的小环境中，并且修改jython的启动脚本修改PYTHONPATH的设置，保证Java依赖对Jython的透明可访问。</p>

<p><h3>Nodejs</h3>
nodejs是一个新兴的生态系统，一个包管理工具对其也是必不可少。npm是目前整个社区都比较认可的工具。</p>

<p>不过目前npm并不好用。npm默认会把自己安装到 node安装前缀的目录，比如node安装时你选择了默认前缀/usr/local，那么npm会把自己安装到/usr/local/lib/node里。这个目录是系统级别的，所以需要root权限，而npm本身又不鼓励用户用root权限来安装软件包（安全问题）。所以作者说希望用户把/usr/local/lib/node权限授予用户，或者把node安装到用户目录里。这两种方式其实都不太优雅。</p>

<p>Ruby的gems在这方面最符合unix哲学，即用户知道自己在做什么。如果用户以root权限运行gem  install，gem会把软件包安装到系统目录中对所有用户可用，而如果以普通用户权限运行，则安装到用户目录 $HOME/.gem 中仅当前用户可见。</p>

<p>nodejs在加载软件包时，会在require.paths中的几个目录里查找，前两个都是用户目录，所以npm也并非一定要把包安装到系统目录里去。虽然现在可以用过修改.npmrc文件在修改npm的默认行为，不过在这个CoC的时代，显然太繁琐了。</p>

<p><h3>Best Pratice</h3>
总结一下，包管理和路径管理的最佳实践应该是：语言平台有CoC的路径机制，包管理器有基于环境变量、用户权限的判断执行合适行为。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2011/01/14/update-on-exaile-soundmenu-indicator-and-exaile-doubanfm-plugin/">Update on Exaile-soundmenu-indicator and Exaile-doubanfm-plugin</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-01-14T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><h3>Exaile-soundmenu-indicator</h3>
As many users complaint about the &#8220;minimise to sound menu&#8221; issue, I updated exaile-soundmenu-indicator plugin. Now it is basically compliant with specification of <a href="https://wiki.ubuntu.com/SoundMenu">SoundMenu</a>: it will keep playing if you click the close button while the player is playing, and will exit if not playing. However, to be able to complete the functionality, you have to commentify the line <strong>1506</strong> of <strong>/usr/lib/exaile/xlgui/main.py</strong>, which is &#8221;<strong>return true</strong>&#8221; of method &#8221;<strong>delete_event</strong>&#8221; (On Ubuntu 10.10, exaile 0.3.2.0-ubuntu3). <strong>Otherwise</strong>, whenever you close the window it won&#8217;t exit.</p>

<p>I know this is a bad idea to require user to modify the source code, but it‘s not possible to override the behavior of a GTK callback, especially when you do not have the handler_id of the callback. If you do not mind the incompliant of closing behavior, you can just keep it as is, and exiting by menu and CRTL+Q.</p>

<p>Grab the snapshot of github repository to get the up-to-date version:
<a href="https://github.com/sunng87/Exaile-Soundmenu-Indicator">https://github.com/sunng87/Exaile-Soundmenu-Indicator</a></p>

<p><h3>Exaile-doubanfm-plugin</h3>
Exaile豆瓣电台插件更新。豆瓣最近调整了登录的策略：
<ul><li>用户在首次访问豆瓣时被设置cookie bid</li>
<li>用户提交登陆表单时被要求提交cookie bid，否则不予通过。</li></ul></p>

<p>此外，这次更新开始使用HTTPS提交用户登录信息。</p>

<p><a href="https://github.com/sunng87/exaile-doubanfm-plugin">https://github.com/sunng87/exaile-doubanfm-plugin</a>，请下载最新0.0.6c。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2011/01/12/html5-form-in-opera-11/">HTML5 Form in Opera 11</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-01-12T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>严格意义上我现在已经不能算是个web guy了，不过托Web开放的特性，咱也能评论一下。最近做个小的界面，考虑到要面向未来，HTML5又提供了丰富的表单增强。这些特性中，Firefox 3.6基本上还没有支持，Chromium 8.0有少部分支持，而真正支持比较完整的是Opera 11.</p>

<p><strong>autofocus</strong>
页面载入后自动将焦点转到某个input，就如以前的onload时候xxx.focus()</p>

<p><strong>required</strong>
指定某个input为必填，提交时会有validation，在Opera11里还会给你这样的警告并且禁止提交：
<a href="http://www.flickr.com/photos/40741608@N08/5349345730/" title="Screenshot - 01122011 - 10:53:41 PM by 贝小塔, on Flickr"><img src="http://farm6.static.flickr.com/5083/5349345730_f6696fd07e.jpg" width="329" height="144" alt="Screenshot - 01122011 - 10:53:41 PM" /></a></p>

<p><strong>email / url</strong>
指定某个input的特殊类型，提交时也会有对应的格式检查：
<a href="http://www.flickr.com/photos/40741608@N08/5348736441/" title="Screenshot - 01122011 - 10:54:41 PM by 贝小塔, on Flickr"><img src="http://farm6.static.flickr.com/5081/5348736441_78accc61ac.jpg" width="344" height="140" alt="Screenshot - 01122011 - 10:54:41 PM" /></a></p>

<p>这样的提示可能满足不了你的替用户着想的产品经理，但是你清楚他帮你省了多少事情。而且，在DiveInfoHtml5里提到，iphone甚至为这个input做了优化，在软件盘上把空格键变得很小（因为输入邮件地址用不着），并且提供了一个@键；这就是工程师的用户体验啊。</p>

<p><strong>placeholder</strong>
在input里显示提示文本：
<a href="http://www.flickr.com/photos/40741608@N08/5349345562/" title="Screenshot - 01122011 - 10:52:18 PM by 贝小塔, on Flickr"><img src="http://farm6.static.flickr.com/5209/5349345562_d658665b92.jpg" width="441" height="63" alt="Screenshot - 01122011 - 10:52:18 PM" /></a></p>

<p>注意到后面的红色星号了吗。这本来是我设计的一个workaround，既然Firefox 3都还不支持required validation，那么我们通过CSS来显示一个必填的提示：<br />
[cc lang=&#8221;css&#8221;]<br />
input[required=&#8221;required&#8221;]:after {<br />
	content: &#8216;(*)&#8217;;<br />
	color: #F00;<br />
}
[/cc]</p>

<p>结果这个伪类最后只有在Opera里实现了预期的效果，看<a href="http://stackoverflow.com/questions/2587669/css-after-pseudo-element-on-input-field">在Stackoverflow上的讨论</a>才得知input的:after和:before伪类只有Opera支持。</p>

<p>HTML5 Form这部分是一个真正务实的标准，你可以看到几乎每一个特性都是我们日常每时每刻都需要，几乎每个网站的JS都要实现的功能。标准是沟通上下游（浏览器和应用开发人员）的契约，一个真正反应相互需求的标准才是有实际价值的。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2011/01/08/soldat-gefr/">Soldat & Gefr</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-01-08T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>我的这一套stack正在走向完整。上次贴了一张soldat-http的图，现在基于soldat的wsgi服务器也已经有了一个基本可以运行的实现，名字叫做gefr（我的命名出处参考<a href="http://en.wikipedia.org/wiki/Rank_insignia_of_the_German_armed_forces">这里</a>）。现在gefr上已经可以跑基于bottle框架的wsgi程序了，也就是说一些基于python的web应用可能可以通过jython来运行在soldat上。为了搞定jython的环境，这几天我还花了不少时间做了jip帮我从maven仓库里自动下载依赖的jar包。</p>

<p>soldat和gefr的代码都放在我的bitbucket上：
<ul>
<li>soldat <a href="https://bitbucket.org/sunng/soldat">https://bitbucket.org/sunng/soldat</a></li>
<li>gefr <a href="https://bitbucket.org/sunng/gefr">https://bitbucket.org/sunng/gefr</a></li>
</ul></p>

<p>此外，这两个项目也分别发布到了<a href="https://oss.sonatype.org/content/repositories/snapshots/">sonatype oss仓库</a>和<a href="http://pypi.python.org/pypi/gefr">python cheese shop</a>。</p>

<p>现在还有几个问题：
<ul>
<li>soldat在读buffer的时候先获得buffer的limit，再去读相应长度的buffer有时会出现BufferUnderflowException。这个可能存在线程安全问题，现在还没发现。</li>
<li>gefr启动之后可以通过在jvisualvm里找到这个进程，但是绑定profiler之后很诡异的是gefr就不再处理请求了。</li>
<li>直接用soldat的处理http请求，吞吐量可以上万；但是在上面加上jython的gefr，再加上bottle框架，同样的功能吞吐量就剩下原来的十分之一了。就是因为没法做profile，所以还不知道时间花到哪里去了。</li>
</ul></p>

<p>简单地 announce 一下，这样我有更多的动力来继续把这两个小东西做好。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2011/01/04/jip-0-1/">Jip 0.1</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-01-04T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The original idea is to create a standalone jython environment, I took <a href="http://sunng.info/blog/2010/12/setup-a-jython-development-environment/">traditional Java tools, ant and ivy</a>, to resolve Java dependencies. But  the XMLs seem to be verbose and not pythonic. So I decide to create something like pip, that is, resolves and installs dependencies in a pythonic way.  It is jip.</p>

<p>jip will automatically download jars and its <strong>non-optional</strong> <strong>runtime</strong> dependencies from Maven repositories. By default, jip will search your local repository and maven central repository for the requested artifact. Also, you can create a configuration file to overwrite this.</p>

<p>Virtualenv is required by jip. You must run jip within a standalone environment, created by virtualenv:
<i>virtualenv -p /usr/local/bin/jython jython-env</i>
<i>cd jython-env</i>
<i>source bin/activate</i></p>

<p>Don&#8217;t forget to activate it.</p>

<p>Then download jip with pip:
<i>pip install jip</i></p>

<p>Now you have pip for python and jip for java. To install a Java package, just type:<br />
jip install &lt;groupId&gt;:&lt;artifactId&gt;:&lt;version&gt;</p>

<p>groupId+artifactId+version is known as the coordinate of a maven artifact. For example, you need spring-core in your jython development:
<i>jip install org.springframework:spring-core:3.0.5.RELEASE</i></p>

<p>The jars will be stored in <i>javalib</i> directory:
<i>ls javalib</i>
<pre>
commons-logging-1.1.1.jar     spring-core-3.0.5.RELEASE.jar
spring-asm-3.0.5.RELEASE.jar
</pre></p>

<p>And When you installed jip, I will provide you a <i>jython-all</i> command to include dependencies by default. So use <i>jython-all</i> instead of <i>jython</i> to run your program and the shell.</p>

<p>For traditional Java user, there is a <i>resolve</i> subcommand to download dependencies defined in a pom file. This is more maintainable, some of you may prefer this way to typing it one by one.
<i>jip resolve pom.xml</i></p>

<p>To define custom repositories, place a dot file <i>.jip</i> in your home directory:<br />
[cc lang=&#8217;ini&#8217;]<br />
[jboss]<br />
uri=http://repository.jboss.org/maven2/<br />
type=remote</p>

<p>[local]<br />
uri=/home/sun/.m2/repository/<br />
type=local</p>

<p>[central]<br />
uri=http://repo1.maven.org/maven2/<br />
type=remote<br />
[/cc]<br />
You may have internal Nexus, just append to this file following the pattern.</p>

<p>Finally, a clean subcommand to remove everything you downloaded.</p>

<p>That&#8217;s all. You can find the project at:
<ul><li><a href="http://pypi.python.org/pypi/jip">http://pypi.python.org/pypi/jip</a></li>
<li><a href="https://github.com/sunng87/jip">https://github.com/sunng87/jip</a></li></ul></p>

<p>Your feedback is appreciate. Fire an issue in github if you find any bugs or new ideas about this tool.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2011/01/01/happy-new-year/">Happy New Year!</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-01-01T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.flickr.com/photos/40741608@N08/5311404087/" title="IMG_0276 by 贝小塔, on Flickr"><img src="http://farm6.static.flickr.com/5081/5311404087_fea4651daf.jpg" width="500" height="375" alt="IMG_0276" /></a>
今天基本上学会了农场主的基本规则，在我看来虽然复杂，但是多少也和波多黎各什么的类似，这大概就是这类桌游的pattern吧。负责任地说，绝对没有两个人玩的晨昏对峙复杂（又是太空又是核武又是战争指数还有全球战场搞神马啊）。这点从桌游店就能看出来，去拿农场主的时候老板还会对你表示一下惊叹和欣赏；可是要玩晨昏对峙呢，根本店里根本找不到。高出不胜寒啊！你一生要是能找到一个棋逢对手的朋友一起玩晨昏对峙，也是一件幸事 -___-。</p>

<p>Anyway，农场主也很好玩，我就喜欢这种卡牌多、道具多的桌游。桌游的道具模型都可以复用了，它的猪和卡卡颂商人扩展里的一模一样。</p>

<p>专心休假，停止劳作。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2010/12/30/setup-a-jython-development-environment/">Setup a Jython Development Environment</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-12-30T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This article will show you some basic steps to setup a standalone environment for Jython, with the power of some popular and standard tools.</p>

<p><h3>0. Install essential tools</h3>
Take Ubuntu Maverick as an example, before starting, you have to make sure these packages installed on your system.</p>

<p><strong>Essential Python tools</strong> (Python is shipped with most Linux distribution by default)
<i>sudo apt-get install python-pip python-virtualenv</i></p>

<p><strong>Java</strong>
<i>sudo apt-get install openjdk-6-jdk openjdk-6-jre</i></p>

<p><strong>Jython</strong>
The Jython package in Ubuntu repository is obsolete. Download Jython installer from official website. A full installation is recommended here.
<a href="http://jython.org/downloads.html">http://jython.org/downloads.html</a></p>

<p>As an optional step, I often move Jython direcotry to /usr/local/share/ , and use a symbol link to add Jython to PATH:
<i>sudo ln -s /usr/local/share/jython/bin/jython /usr/local/bin/</i></p>

<p><strong>Install additional Java tools</strong>
<i>sudo apt-get install ant ivy</i></p>

<p><h3>1. Create a standalone environment</h3>
Jython 2.5 is fully compatible with virtualenv, so you can create a standalone environment just like what you do with python:
<i>virtualenv -p /usr/local/bin/jython jython-env</i>
<i>cd jython-env</i></p>

<p>List the directory, you will see these files and directories:
<ul>
<li>bin/</li>
<li>cachedir/</li>
<li>Lib/</li>
<li>jython.jar</li>
<li>registry</li>
</ul>
Source the activate script:
<i>source bin/activate</i></p>

<p><h3>2. Download and install python packages</h3>
Now the python environment is just ready, you can install python packages as you want. Install bottle, for example:
<i>pip install bottle</i></p>

<p><h3>3. Download and install Java dependencies</h3>
This is the different step. As you know, the most important feature of Jython is availability of Java libraries to Python code. So we need some additional tools to manage Java dependencies. Popular Java lifecycle management tool <strong>Maven</strong> is not suitable here, because Maven is tightly depends on its archetype. <strong>Gradle</strong> is also known as a powerful build tool with DSL support. However, Gradle uses Groovy as the scripting language to create build file. Bringing Groovy to a Jython project seems terribly strange.</p>

<p>So I prefer the traditional Ant way to manage dependencies. First of all, create a build file with following content:
<strong>build.xml</strong>
[cc lang=&#8221;xml&#8221;]
<project xmlns:ivy="antlib:org.apache.ivy.ant" name="jython-env" default="resolve">
    <target name="resolve" description="retrieve dependencies">
        <ivy:retrieve pattern="javalib/[artifact]-[revision].[ext]" type="jar" />
    </target>
</project>
[/cc]</p>

<p>Then create an ivy xml to configure dependencies:
<strong>ivy.xml</strong>
[cc lang=&#8221;xml&#8221;]
<ivy-module version="2.0">
    <info organisation="info.sunng" module="jython-env" />
    <dependencies>
        <dependency org="commons-lang" name="commons-lang" rev="2.5" />
    </dependencies>
</ivy-module>
[/cc]</p>

<p>Also, as an optional step, you can overwrite default settings to configure ivy to use maven local repository.
<strong>ivysettings.xml</strong>
[cc lang=&#8221;xml&#8221;]
<ivy-settings>
    <settings defaultresolver="maven-or-not" />
    <resolvers>
        <chain name="maven-or-not" returnfirst="true">
            <filesystem name="maven-local" m2compatible="true" />
            <ibiblio name="ibiblio" m2compatible="true" />
        </chain>
    </resolvers>
</ivy-settings>
[/cc]</p>

<p>All done, now you can download everything. In Ubuntu, default ivy installation, you have to specify ivy path in ant command line:
<i>ant -lib /usr/share/java/ivy.jar</i></p>

<p>You will see jars in <i>javalib</i>.</p>

<p><h3>4. Reconfigure start up script</h3>
The default Jython start up script is not friendly to external Java dependencies. To include jars, you have to use such dirty command line parameters:
<i>jython -Dpython.path=javalib/commons-lang-2.5.jar:javalib/&#8230;</i></p>

<p>To get rid of this, first rename bin/jython to bin/startJython. (Follow the Groovy naming convention)</p>

<p>Then create a new bin/jython script wraps the old one:<br />
[cc lang=&#8221;bash&#8221;]<br />
#! /bin/bash</p>

<p>JYTHON_CMD=&#8221;startJython&#8221;<br />
JAVA_LIBS=&#8221;javalib/*.jar&#8221;<br />
PYTHON_PATH=&#8221;&#8221;</p>

<p>for lib in $JAVA_LIBS<br />
do<br />
    PYTHON_PATH=&#8221;$PYTHON_PATH:$lib&#8221;<br />
done</p>

<p>#echo $PYTHON_PATH<br />
$JYTHON_CMD -Dpython.path=$PYTHON_PATH</p>

<p>[/cc]</p>

<p><h3>5. Run</h3>
Finally, it comes to an end. Type jython to execute the interactive shell:
<i>jython</i>
<blockquort>
Jython 2.5.1 (Release_2_5_1:6813, Sep 26 2009, 13:47:54)<br />
[OpenJDK Server VM (Sun Microsystems Inc.)] on java1.6.0_20<br />
Type &#8220;help&#8221;, &#8220;copyright&#8221;, &#8220;credits&#8221; or &#8220;license&#8221; for more information.<br />
>>> from org.apache.commons.lang import BitField<br />
>>> import bottle
</blockquort></p>

<p>Both Python and Java dependency is accessible. Now it&#8217;s time to get your new start.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2010/12/28/my-first-http-server-soldat-http/">My First Http Server, Soldat-http</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-12-28T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>2008年的冬天，有一天和一个不认识的网友聊天，他说，以前也对这些框架啦什么的感兴趣，后来就变了，他说他当时的目标是写一个HTTP服务器。我当时能够认同他的观点，不过没什么特别的共鸣。到了今天春天，项目开始了，周末老大休假回杭州，留下大伙大眼瞪小眼要联调。出现了问题发现自己一窍不通，然后开玩笑说一定要把老大的NIO框架看懂才跳槽。结果不幸还没来得及怎么看就闪人了，还好老大<a href="http://code.google.com/p/amoeba/">开源</a>，现在依然还可以偷偷看看。另外，我还隐约记得09年冬天的时候，似乎也给自己定过个类似一年之内写个HTTP服务器之类的目标。</p>

<p>所以我说，自己写程序是一件<a href="http://blog.samsonis.me/2010/12/wordpress-%e8%b1%86%e7%93%a3%e6%8f%92%e4%bb%b6-douban-collections-%e8%b1%86%e7%93%a3%e6%94%b6%e8%97%8f-0-9-0/#comment-1299">情怀驱动</a>的事情：就像<a href="http://blog.samsonis.me/">有些同学</a>一再强调自己再也不写<a href="http://wordpress.org/extend/plugins/douban-collections/">wordpress插件</a>了，可是还是不断有<a href="http://blog.samsonis.me/2010/12/wordpress-%E8%B1%86%E7%93%A3%E6%8F%92%E4%BB%B6-douban-collections-%E8%B1%86%E7%93%A3%E6%94%B6%E8%97%8F-0-9-0/">新版本发布</a>。</p>

<p>好吧，其实这个目标最后没有实现。目前这个版本仅仅是能够work，在2010年快要结束的时候赶紧把他搬出来，聊以自慰，嗯，我这一年不是一无所获。
<a href="http://www.flickr.com/photos/40741608@N08/5300136156/" title="Screenshot - 12282010 - 09:17:59 PM by 贝小塔, on Flickr"><img src="http://farm6.static.flickr.com/5124/5300136156_7a29dfb2f9.jpg" width="500" height="396" alt="Screenshot - 12282010 - 09:17:59 PM" /></a></p>

<p>接下来我还会进一步完善它和底层的事件驱动框架，还有意完成一个Jython的WSGI实现。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2010/12/24/lm-tooling-2010/">LM Tooling, 2010</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-12-24T00:00:00+08:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>阿哈，大家都开始总结2010年了，我也想找个角度来总结一下今年。三句不理老本行，还是聊软件开发周边的事情。Lifecycle Management Tooling，软件生命周期管理的工具和我一年的感受。</p>

<p>一月份的时候我还有大把的业余时间，在做一个叫做<a href="https://bitbucket.org/sunng/yan">Yan</a>的验证码服务。这个项目从我刚一到盛大工作就开始了，不过因为没有特别的需求，最后变成了自己的开源项目。这个项目用Maven做dependency management，用hg做版本控制，代码放在bitbucket上。它对Maven的使用还很基本，是一个Single Module的小项目，因为服务本身已经实现了插件机制，本来我准备把它拆成Multimodule的Maven工程来着，不过后来因为比较忙，这件事就放掉了。那时我已经开始尝试用hg进行分支管理、每个release打tag，甚至还有一段时间会有一些两个分支的并行开发。这些基本上是实验性质的尝试，不过和后来相比也算是做的比较规范的了。</p>

<p>三月份我注册了github，顺带就开始用git了。到目前为止，我对hg和git的区别还没有特别的感受，选择的主要依据其实bitbucket和github。相对social一些的项目，github是当仁不让的选择。bitbucket上人少比较清净，一些incubator项目放在上面，烂尾了也不至于太丢脸。扯远了，哈哈。</p>

<p>之后我们开始做一个规模比较大的项目，我们使用Maven，使用Nexus，使用SVN。项目规模比较大，我们有数个Multimodule的Maven项目，遇到的第一个问题就是集成的成本非常大。最初几周，我都是在自己的机器上做集成，Windows，你懂的，又不太方便做自动化，结果整个过程非常痛苦。到了四月份项目还没有全部完成，已经不能忍了，于是我引入了Hudson。我们为每一个项目创建单独的build task，unstable的构建会有邮件通知开发人员。一方面把我从每天反复的手动集成打包中解脱出来，另一方面也促进了大家写高质量的UnitTest，因为一旦有测试不通过就会有一个虚构的200000000@snda.com的邮箱给大家发邮件，以至于最后几乎所有人都把这个地址拉黑了。</p>

<p>写真正能够Automation的单元测试其实很不简单，尤其是DAL层。理想的solution是用内存数据库来做单元测试的数据源，不过在实际开发里，因为一些SQL会依赖特定的数据库，所以这个方案并不太理想。如果有事务的话，Spring的TestCase可以设置自动回滚，可是互联网项目，你也懂的，连一致性都搞成最终一致了，事务这么重的东西我们是不用的。</p>

<p>我们遇到的另一个问题是，多个独立的Maven项目，在做集成时，会存在依赖的冲突。这类问题一旦出现，找原因的代价还是比较大的。这方面，老大有一个Best Practice，定义一个统一的、专门管理版本的pom，通过dependency management的import来使用，你可以<a href="http://sunng.info/blog/2010/05/maven-recipe-0/">看这里</a>来了解。</p>

<p>我们suffer的另一个问题是SVN的分支管理，到了项目的后期，功能越来越多，也出现了两个分支的并行开发，回滚的情况也出现了。我们基本上可以保证每次发布都有tag，但是分支的管理实在是非常痛苦。我现在的认识是，两方面原因。第一，SVN的分支成本还是比较高的，远程整个目录拷贝一下，本地需要指向新的地址。第二，项目的计划不明确，根本没有办法去估计新的分支、新的版本。两个原因结合起来说，其实分支管理不完全是一个版本控制系统层面的问题，和整个项目规划都有一定的联系。</p>

<p>到了后期，我们对Hudson的使用也有了一些最佳实践，结合ssh/scp的插件，task的trigger机制，我们有了自动化的部署，你可以在<a href="http://sunng.info/blog/2010/09/hudson-tips/">这里</a>了解。不过我们的自动化最后倒在公司强制的动态密码验证机制上，每次登录需要使用动态密码，这样一切最后又都回归了手动。</p>

<p>除了在公司的项目，在9月份我又做了一个实验性的项目，叫做<a href="https://github.com/sunng87/bason">Bason</a>，他可以在编译时生成JavaBean到Mongodb BSON代码。也是用Maven管理，不过值得一提的是，我申请了Sonatype提供的<a href="https://docs.sonatype.org/display/Repository/Sonatype+OSS+Maven+Repository+Usage+Guide">OSS Repository</a>，这样可以把项目都deploy到公共的服务器上，使用会非常方便。还值得一提的是，OSS Repository的管理者是校友<a href="http://www.juvenxu.com/">@Juvenxu</a></p>

<p>不过今年Maven并不是Java生命周期管理的唯一工具，还有一些工具也开始进入视线，当然我说的不是ant+ivy。前段时间发布0.9的<a href="http://gradle.org/">Gradle</a>是比较受关注的，它又回归了ant的task oriented ，结合Groovy的DSL和插件机制提供更高的灵活性。另外，断断续续学了一年的clojure，clojure的生态系统里已经有了一个叫做<a href="https://github.com/technomancy/leiningen">leinigen</a>的生命周期管理工具，在clojure的世界里，它非常好用。</p>

<p>另外Python的世界，我逐渐开始强制自己用virtualenv来创建一个更可控，更具有移植性的python环境。随着年底开始的一个小项目，我应该对python项目的生命周期管理有更深的认识。</p>

<p>年底到了SAP，开始在NetWeaver平台上做Abap开发。NetWeaver是一个复杂的平台，它的Scope也涵盖了生命周期管理。在NetWeaver中，开发一个非local的程序，需要首先创建一个Change Request，之后所有的变更，最后都会保存到这个ChangeRequest上，有些类似传统的分支。当开发完成后，开发人员把change request release掉，这部分代码会自动被transport到Test系统或者其他下游系统上。实际开发里，一个Change Request可能对应一个Ticket，一个特性。这样的平台上，开发人员需要额外操心的事情，非常少。</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/blog/page/17/">&larr; Older</a>
    
    <a href="/blog/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/blog/page/15/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p>Ning Sun. Programmer. Map enthusiast. (<a href="http://sunng.info/">more</a>)</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/blog/2014/05/27/fork-join-in-papaline/">Fork-Join in Papaline</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2014/04/20/concurrent-pipeline-with-core-async/">Papaline: Concurrent Pipeline With core.async</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2014/04/20/rust-concurrent-made-safely/">Rust语言：安全的并发</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2014/03/04/slacker-0-dot-11-released/">Slacker Library Updated</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/10/22/swapping-harddisk-without-pain/">Archlinux 安全更换硬盘</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/sunng87">@sunng87</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'sunng87',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/blog/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>On Delicious</h1>
  <div id="delicious"></div>
  <script type="text/javascript" src="http://feeds.delicious.com/v2/json/classicing?count=3&amp;sort=date&amp;callback=renderDeliciousLinks"></script>
  <p><a href="http://delicious.com/classicing">My Delicious Bookmarks &raquo;</a></p>
</section>




  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Sun Ning -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'sunng-blog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
